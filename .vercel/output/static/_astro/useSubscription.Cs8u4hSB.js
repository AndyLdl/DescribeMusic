import{r as p}from"./index.D5cfIYOg.js";import{u as D,s as h}from"./CreditContext.Cd34fGmH.js";var E={};function M(n){return E[n]}function q(n,t){E[n]=t}var L="__config__",R="https://api.lemonsqueezy.com";function C(n){return!n||!Array.isArray(n)||!n.length?"":`?include=${n.join(",")}`}function N(n){for(let t in n)if(!n[t])throw Error(`Please provide the required parameter: ${t}.`)}function T(n){let{apiKey:t,onError:e}=n;return q(L,{apiKey:t,onError:e}),n}async function z(n,t=!0){let e={statusCode:null,data:null,error:Error()},{apiKey:s,onError:o}=M(L)||{};try{if(t&&!s)return e.error=P("Please provide your Lemon Squeezy API key. Create a new API key: https://app.lemonsqueezy.com/settings/api","Missing API key"),o?.(e.error),e;let{path:a,method:u="GET",query:b,body:I}=n,m={method:u},r=new URL(`${R}${a}`);for(let l in b)r.searchParams.append(l,b[l]);m.headers=new Headers,m.headers.set("Accept","application/vnd.api+json"),m.headers.set("Content-Type","application/vnd.api+json"),t&&m.headers.set("Authorization",`Bearer ${s}`),["PATCH","POST"].includes(u)&&(m.body=I?JSON.stringify(I):null);let i=await fetch(r.href,m),y=await i.json(),A=i.ok,g=i.status;if(A)Object.assign(e,{statusCode:g,data:y,error:null});else{let{errors:l,error:v,message:S}=y,d=l||v||S||"unknown cause";Object.assign(e,{statusCode:g,data:y,error:P(i.statusText,d)})}}catch(a){Object.assign(e,{error:a})}return e.error&&o?.(e.error),e}function P(n,t="unknown"){let e=new Error(n);return e.name="Lemon Squeezy Error",e.cause=t,e}function k(n,t={}){return N({subscriptionId:n}),z({path:`/v1/subscriptions/${n}${C(t.include)}`})}function U(n){return N({subscriptionId:n}),z({path:`/v1/subscriptions/${n}`,method:"DELETE"})}const j={name:"Free Trial",credits:100,creditsLoggedIn:200,description:"Free trial of AI audio analysis",features:["Not logged in: 100 credits (1.7 minutes)","Logged in: 200 credits monthly (3.3 minutes)","Basic audio analysis features","Supports MP3 format (max 10MB)","View analysis results online","Community support"],limitations:["No export functionality","No batch processing support","No API access","MP3 format only","10MB file size limit"]},_={basic:{id:"basic",name:"Basic Plan",price:9.9,credits:1200,variantId:"999961",description:"Perfect for light users",features:["1200 credits monthly (20 minutes)","PDF/TXT report export","Supports MP3, WAV formats","Max file size 50MB","Advanced audio analysis","Email customer support","History record saving"],audioFormats:["MP3","WAV"],maxFileSize:"50MB",exportFormats:["PDF","TXT"],hasExport:!0,hasBatchProcessing:!1,hasAPI:!1,analysisLevel:"advanced",supportLevel:"email"},pro:{id:"pro",name:"Professional Plan",price:19.9,credits:3e3,variantId:"999967",description:"Perfect for professional users",popular:!0,features:["3000 credits monthly (50 minutes)","Multi-format report export","Supports all audio file formats","Max file size 200MB","Advanced audio analysis","History record saving","🚧 Batch processing feature (In Development)","🚧 API access permissions (In Development)","Email customer support"],audioFormats:["MP3","WAV","M4A","OGG","WMA"],maxFileSize:"200MB",exportFormats:["PDF","TXT","CSV","JSON"],hasExport:!0,hasBatchProcessing:"coming_soon",hasAPI:"coming_soon",analysisLevel:"advanced",supportLevel:"email"},premium:{id:"premium",name:"Enterprise Plan",price:39.9,credits:7200,variantId:"999967",description:"Perfect for enterprises and heavy users",features:["7200 credits monthly (120 minutes)","Complete report suite export","Supports all audio file formats","Max file size 200MB","Advanced audio analysis","History record saving","🚧 Batch processing feature (In Development)","🚧 API access permissions (In Development)","Email customer support"],audioFormats:["MP3","WAV","M4A","OGG","WMA"],maxFileSize:"200MB",exportFormats:["PDF","TXT","CSV","JSON"],hasExport:!0,hasBatchProcessing:"coming_soon",hasAPI:"coming_soon",analysisLevel:"advanced",supportLevel:"email"}};class c extends Error{constructor(t,e,s){super(t),this.code=e,this.statusCode=s,this.name="LemonsqueezyError"}}class f{static instance;apiKey;storeId;isInitialized=!1;constructor(){const t="eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJhdWQiOiI5NGQ1OWNlZi1kYmI4LTRlYTUtYjE3OC1kMjU0MGZjZDY5MTkiLCJqdGkiOiJjZWY4MDU1Y2E2NzI4YjM3NzAxMTU5MzEwYzkzNmQ0YjA2OGI3OWQ1MDFkODNhYTAxYjAyN2I3N2RjYjkzYTBlNWVmMWM3YWMzZjA0ODBkYyIsImlhdCI6MTc1ODIxNDU0Ny43NTY3OTYsIm5iZiI6MTc1ODIxNDU0Ny43NTY3OTksImV4cCI6MjA3Mzc0NzM0Ny43NDM0NCwic3ViIjoiMTkxNDAxMSIsInNjb3BlcyI6W119.as4QEOlT0uK1bOQC8C464bjvdgH4Icsf0MZMLLps4L2aVPnnVdqInbQYQG-x_PGJwY2qPdugjm1zPorVEFDdyboqMJKWLshEA-j8mXbcZeSu91u05YKKT5vE1ekZTvDrvMN8QAtQNvJ6mZLqWlpasHDOdbZYHM9uwjSYa4-zRMYbjVvEHtB0tJtRF1U8NxlUGnRkGmqWLITx-b-xb5XNjF2Pe-Y85SJJhyU0Sf0K1nfjWvKNebzYoMfwuCHXUdEjVsJvLcrZwNuLRO47YOIGwXJISQa2mqAx2PqONNs37QKz4ACWy6mPSRaz59XhTZueIHz8rqMn5adAQ6oApaEMGvcVpToAGfZknIqKpm5nt0JakFTFCEfGfKDGskpsDDXIyyxaUhVRF87xXNkM7mP7PXRcW4BsJ3EM1H_nj7VzQ194JUFDISc-nQuIefQDnTIShYLKCaMbAfuo_J6GfHUYGrEO11ryljU5q95_Mj5M6ztdjuPDKHkUCURDd7d2rtpX";this.apiKey=t,this.storeId="76046",!this.apiKey||this.storeId}static getInstance(){return f.instance||(f.instance=new f),f.instance}async initialize(){if(!this.isInitialized){if(!this.apiKey)throw new c("Lemonsqueezy API key not configured","MISSING_API_KEY");try{T({apiKey:this.apiKey,onError:t=>{console.error("Lemonsqueezy SDK Error:",t)}}),this.isInitialized=!0}catch{throw new c("Failed to initialize Lemonsqueezy SDK","INITIALIZATION_FAILED")}}}async createCheckout(t,e={}){await this.initialize();const s=_[t];if(!s)throw new c(`Invalid plan ID: ${t}`,"INVALID_PLAN_ID");if(!s.variantId)throw new c(`Variant ID not configured for plan: ${t}`,"MISSING_VARIANT_ID");try{const o={data:{type:"checkouts",attributes:{checkout_options:{embed:!1,media:!1,logo:!0,desc:!0,discount:!0,dark:!1,subscription_preview:!0,button_color:"#3B82F6"},checkout_data:{email:e.userEmail||"",name:e.userName||"",custom:{user_id:e.userId||"",plan_id:t,credits:s.credits.toString(),...e}},product_options:{name:s.name,description:`${s.description} - ${s.credits} credits`,media:[],redirect_url:`${window.location.origin}/analyze?payment=success`,receipt_button_text:"Return to App",receipt_link_url:`${window.location.origin}/analyze`,receipt_thank_you_note:"Thank you for your purchase! Credits will be added to your account within a few minutes."}},relationships:{store:{data:{type:"stores",id:this.storeId}},variant:{data:{type:"variants",id:s.variantId}}}}};this.storeId,s.variantId;const a=await fetch("https://api.lemonsqueezy.com/v1/checkouts",{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,Accept:"application/vnd.api+json","Content-Type":"application/vnd.api+json"},body:JSON.stringify(o)});if(!a.ok){const b=await a.text();throw console.error("Lemonsqueezy API error:",{status:a.status,statusText:a.statusText,error:b}),new c(`API request failed: ${a.status} ${a.statusText}`,"API_REQUEST_FAILED",a.status)}const u=await a.json();if(!u.data)throw new c("Invalid response from Lemonsqueezy","INVALID_RESPONSE");return u.data,u}catch(o){throw console.error("Lemonsqueezy createCheckout error:",o),o instanceof c?o:new c("Failed to create checkout session","CHECKOUT_CREATION_FAILED",500)}}async getSubscription(t){if(await this.initialize(),!t)throw new c("Subscription ID is required","MISSING_SUBSCRIPTION_ID");try{const e=await k(t);return e.data?e:null}catch(e){if(console.error("Lemonsqueezy getSubscription error:",e),e&&typeof e=="object"&&"status"in e&&e.status===404)return null;throw new c("Failed to get subscription","GET_SUBSCRIPTION_FAILED",500)}}async cancelSubscription(t){if(await this.initialize(),!t)throw new c("Subscription ID is required","MISSING_SUBSCRIPTION_ID");try{const e=await U(t);if(e?.data,e?.statusCode,e?.error,!e)throw new c("No response from Lemonsqueezy API","NO_RESPONSE");if(e.error)throw new c(`Lemonsqueezy API error: ${e.error.message||e.error}`,"API_ERROR");if(!e.data)throw new c("Invalid response from Lemonsqueezy - no data field","INVALID_RESPONSE");return e}catch(e){throw console.error("Lemonsqueezy cancelSubscription error:",e),e instanceof c?e:new c("Failed to cancel subscription","CANCEL_SUBSCRIPTION_FAILED",500)}}static verifyWebhookSignature(t,e,s){if(!t||!e||!s)return!1;try{const o=require("crypto"),a=o.createHmac("sha256",s);a.update(t,"utf8");const u=a.digest("hex");return o.timingSafeEqual(Buffer.from(e,"hex"),Buffer.from(u,"hex"))}catch(o){return console.error("Webhook signature verification error:",o),!1}}static getPlan(t){return _[t]}static getAllPlans(){return Object.values(_)}static getPlanByVariantId(t){return Object.values(_).find(e=>e.variantId===t)}isConfigured(){return!!(this.apiKey&&this.storeId)}getConfigStatus(){return{hasApiKey:!!this.apiKey,hasStoreId:!!this.storeId,isConfigured:this.isConfigured(),plans:Object.keys(_).map(t=>({id:t,hasVariantId:!!_[t].variantId}))}}}class O{service;constructor(){this.service=f.getInstance()}async getUserSubscriptionStatus(t){try{const e=await this.service.getSubscription(t);if(!e)return{isActive:!1,status:"not_found",subscription:null};const s=e.data.attributes.status;return{isActive:["active","on_trial"].includes(s),status:s,subscription:{id:e.data.id,status:e.data.attributes.status,statusFormatted:e.data.attributes.status_formatted,productName:e.data.attributes.product_name,variantName:e.data.attributes.variant_name,userEmail:e.data.attributes.user_email,renewsAt:new Date(e.data.attributes.renews_at),endsAt:e.data.attributes.ends_at?new Date(e.data.attributes.ends_at):null,cancelled:e.data.attributes.cancelled,trialEndsAt:e.data.attributes.trial_ends_at?new Date(e.data.attributes.trial_ends_at):null,urls:e.data.attributes.urls,cardBrand:e.data.attributes.card_brand,cardLastFour:e.data.attributes.card_last_four}}}catch(e){return console.error("Failed to get subscription status:",e),{isActive:!1,status:"error",subscription:null,error:e instanceof Error?e.message:"Unknown error"}}}async checkRenewalReminder(t){try{const e=await this.getUserSubscriptionStatus(t);if(!e.isActive||!e.subscription)return{needsReminder:!1};const s=e.subscription.renewsAt,o=new Date,a=Math.ceil((s.getTime()-o.getTime())/(1e3*60*60*24));return{needsReminder:a<=7&&a>0,daysUntilRenewal:a,renewalDate:s}}catch(e){return console.error("Failed to check renewal reminder:",e),{needsReminder:!1}}}async cancelUserSubscription(t){try{const e=await this.service.cancelSubscription(t);if(!e)throw new Error("No response from Lemonsqueezy API");if(!e.data)throw console.error("❌ Invalid response structure:",e),new Error("Invalid response structure from Lemonsqueezy API");const s={id:e.data.id,status:e.data.attributes?.status||"cancelled",cancelled:e.data.attributes?.cancelled||!0,endsAt:e.data.attributes?.ends_at?new Date(e.data.attributes.ends_at):null};return{success:!0,subscription:s}}catch(e){console.error("❌ Failed to cancel subscription:",e);let s="Unknown error";return e instanceof Error?s=e.message:typeof e=="string"?s=e:e&&typeof e=="object"&&(s=JSON.stringify(e)),{success:!1,error:s}}}getSubscriptionCredits(t){return f.getPlanByVariantId(t)?.credits||0}formatSubscriptionStatus(t){return{active:"Active",on_trial:"On Trial",paused:"Paused",past_due:"Past Due",unpaid:"Unpaid",cancelled:"Cancelled",expired:"Expired"}[t]||t}canModifySubscription(t){return["active","on_trial"].includes(t)}async getCustomerPortalUrl(t){try{const e=await this.getUserSubscriptionStatus(t);return e.subscription?e.subscription.urls.customer_portal:null}catch(e){return console.error("Failed to get customer portal URL:",e),null}}async syncSubscriptionStatus(t,e){try{const s=await this.getUserSubscriptionStatus(t);return s.subscription?{success:!0,subscriptionData:{lemonsqueezy_subscription_id:s.subscription.id,status:s.subscription.status,current_period_start:s.subscription.renewsAt,current_period_end:s.subscription.endsAt,cancel_at_period_end:s.subscription.cancelled,plan_name:s.subscription.variantName,plan_credits:this.getSubscriptionCredits(s.subscription.id)}}:{success:!1,error:"Subscription not found"}}catch(s){return console.error("Failed to sync subscription status:",s),{success:!1,error:s instanceof Error?s.message:"Unknown error"}}}}const w=new O;function B(){const{user:n}=D(),[t,e]=p.useState({subscription:null,isActive:!1,isLoading:!0,error:null,canSubscribe:!0,needsRenewal:!1,daysUntilRenewal:null}),s=p.useCallback(async()=>{if(!n){e(r=>({...r,subscription:null,isActive:!1,isLoading:!1,canSubscribe:!0,needsRenewal:!1,daysUntilRenewal:null}));return}try{e(d=>({...d,isLoading:!0,error:null}));const{data:r,error:i}=await h.from("subscriptions").select("*").eq("user_id",n.id).in("status",["active","on_trial"]).order("created_at",{ascending:!1}).limit(1).single();if(i&&i.code!=="PGRST116"){i.message,e(d=>({...d,subscription:null,isActive:!1,isLoading:!1,canSubscribe:!0,needsRenewal:!1,daysUntilRenewal:null}));return}if(!r){n.id,e(d=>({...d,subscription:null,isActive:!1,isLoading:!1,canSubscribe:!0,needsRenewal:!1,daysUntilRenewal:null}));return}const y={id:r.lemonsqueezy_subscription_id,status:r.status,statusFormatted:r.status,productName:r.plan_name||"Unknown Plan",variantName:r.variant_name||r.plan_name||"Unknown Variant",renewsAt:new Date(r.current_period_end||r.created_at),endsAt:r.ends_at?new Date(r.ends_at):null,cancelled:r.cancel_at_period_end||!1,trialEndsAt:r.trial_ends_at?new Date(r.trial_ends_at):null,urls:{update_payment_method:r.update_payment_method_url||"",customer_portal:r.customer_portal_url||""},cardBrand:r.card_brand||"",cardLastFour:r.card_last_four||"",credits:r.credits_per_month||0},A=new Date,g=y.renewsAt,l=Math.ceil((g.getTime()-A.getTime())/(1e3*60*60*24)),v=l<=7&&l>0,S=["active","on_trial"].includes(r.status);e(d=>({...d,subscription:y,isActive:S,isLoading:!1,canSubscribe:!S,needsRenewal:v,daysUntilRenewal:l>0?l:null,error:null}))}catch(r){console.error("Error fetching subscription:",r),e(i=>({...i,isLoading:!1,error:r instanceof Error?r.message:"Unknown error"}))}},[n]),o=p.useCallback(async()=>{if(!t.subscription||!n)throw new Error("No active subscription to cancel");try{t.subscription.id;const r=await w.cancelUserSubscription(t.subscription.id);if(!r.success)throw new Error(r.error||"Failed to cancel subscription with Lemonsqueezy");const{error:i}=await h.from("subscriptions").update({status:"cancelled",cancel_at_period_end:!0,updated_at:new Date().toISOString()}).eq("user_id",n.id).eq("lemonsqueezy_subscription_id",t.subscription.id);return await s(),{success:!0,subscription:{id:t.subscription.id,status:"cancelled",cancelled:!0,endsAt:t.subscription.renewsAt}}}catch(r){throw console.error("❌ Error canceling subscription:",r),r}},[t.subscription,n,s]),a=p.useCallback(async()=>{if(!t.subscription||!n)return null;try{if(t.subscription.id,t.subscription.urls.customer_portal)return t.subscription.urls.customer_portal;const{data:r}=await h.from("subscriptions").select("lemonsqueezy_subscription_id, customer_portal_url").eq("user_id",n.id).in("status",["active","on_trial"]).single();if(!r?.lemonsqueezy_subscription_id)return"https://app.lemonsqueezy.com/my-orders";try{const i=await w.getUserSubscriptionStatus(r.lemonsqueezy_subscription_id);if(i.subscription?.urls?.customer_portal)return await h.from("subscriptions").update({customer_portal_url:i.subscription.urls.customer_portal,updated_at:new Date().toISOString()}).eq("user_id",n.id).eq("lemonsqueezy_subscription_id",r.lemonsqueezy_subscription_id),i.subscription.urls.customer_portal}catch(i){}return r.customer_portal_url?r.customer_portal_url:"https://app.lemonsqueezy.com/my-orders"}catch(r){return console.error("❌ Error getting customer portal URL:",r),"https://app.lemonsqueezy.com/my-orders"}},[t.subscription,n]),u=p.useCallback(async()=>{if(!(!n||!t.subscription))try{const r=await w.syncSubscriptionStatus(t.subscription.id,n.id);if(r.success&&r.subscriptionData){const{error:i}=await h.from("subscriptions").update({status:r.subscriptionData.status,plan_name:r.subscriptionData.plan_name,current_period_start:r.subscriptionData.current_period_start?.toISOString(),current_period_end:r.subscriptionData.current_period_end?.toISOString(),cancel_at_period_end:r.subscriptionData.cancel_at_period_end,updated_at:new Date().toISOString()}).eq("user_id",n.id).eq("lemonsqueezy_subscription_id",t.subscription.id);i&&console.error("Error updating subscription in database:",i)}}catch(r){console.error("Error syncing subscription status:",r)}},[n,t.subscription]),b=p.useCallback(async()=>{await s()},[s]);p.useEffect(()=>{s()},[s]);const I=p.useCallback(r=>w.formatSubscriptionStatus(r),[]),m=p.useCallback(r=>w.canModifySubscription(r),[]);return{...t,cancelSubscription:o,getCustomerPortalUrl:a,syncSubscriptionStatus:u,refreshSubscription:b,formatStatus:I,canModifySubscription:m}}export{j as F,f as L,_ as S,c as a,B as u};
