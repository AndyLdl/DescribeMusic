import{g as Kt,a as pr,c as _r,r as P,R as vr}from"./index.D5cfIYOg.js";var He={exports:{}},Ee={};/**
 * @license React
 * react-jsx-runtime.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var vt;function wr(){if(vt)return Ee;vt=1;var n=Symbol.for("react.transitional.element"),e=Symbol.for("react.fragment");function t(r,s,i){var o=null;if(i!==void 0&&(o=""+i),s.key!==void 0&&(o=""+s.key),"key"in s){i={};for(var l in s)l!=="key"&&(i[l]=s[l])}else i=s;return s=i.ref,{$$typeof:n,type:r,key:o,ref:s!==void 0?s:null,props:i}}return Ee.Fragment=e,Ee.jsx=t,Ee.jsxs=t,Ee}var wt;function yr(){return wt||(wt=1,He.exports=wr()),He.exports}var Jt=yr();const mr="modulepreload",br=function(n){return"/"+n},yt={},Re=function(e,t,r){let s=Promise.resolve();if(t&&t.length>0){let o=function(c){return Promise.all(c.map(u=>Promise.resolve(u).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),a=l?.nonce||l?.getAttribute("nonce");s=o(t.map(c=>{if(c=br(c),c in yt)return;yt[c]=!0;const u=c.endsWith(".css"),h=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${h}`))return;const p=document.createElement("link");if(p.rel=u?"stylesheet":mr,u||(p.as="script"),p.crossOrigin="",p.href=c,a&&p.setAttribute("nonce",a),document.head.appendChild(p),u)return new Promise((g,k)=>{p.addEventListener("load",g),p.addEventListener("error",()=>k(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(o){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=o,window.dispatchEvent(l),!l.defaultPrevented)throw o}return s.then(o=>{for(const l of o||[])l.status==="rejected"&&i(l.reason);return e().catch(i)})},kr=n=>{let e;return n?e=n:typeof fetch>"u"?e=(...t)=>Re(async()=>{const{default:r}=await Promise.resolve().then(()=>ke);return{default:r}},void 0).then(({default:r})=>r(...t)):e=fetch,(...t)=>e(...t)};class dt extends Error{constructor(e,t="FunctionsError",r){super(e),this.name=t,this.context=r}}class Sr extends dt{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class mt extends dt{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class bt extends dt{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var tt;(function(n){n.Any="any",n.ApNortheast1="ap-northeast-1",n.ApNortheast2="ap-northeast-2",n.ApSouth1="ap-south-1",n.ApSoutheast1="ap-southeast-1",n.ApSoutheast2="ap-southeast-2",n.CaCentral1="ca-central-1",n.EuCentral1="eu-central-1",n.EuWest1="eu-west-1",n.EuWest2="eu-west-2",n.EuWest3="eu-west-3",n.SaEast1="sa-east-1",n.UsEast1="us-east-1",n.UsWest1="us-west-1",n.UsWest2="us-west-2"})(tt||(tt={}));var Er=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function l(u){try{c(r.next(u))}catch(h){o(h)}}function a(u){try{c(r.throw(u))}catch(h){o(h)}}function c(u){u.done?i(u.value):s(u.value).then(l,a)}c((r=r.apply(n,e||[])).next())})};class xr{constructor(e,{headers:t={},customFetch:r,region:s=tt.Any}={}){this.url=e,this.headers=t,this.region=s,this.fetch=kr(r)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e,t={}){var r;return Er(this,void 0,void 0,function*(){try{const{headers:s,method:i,body:o}=t;let l={},{region:a}=t;a||(a=this.region);const c=new URL(`${this.url}/${e}`);a&&a!=="any"&&(l["x-region"]=a,c.searchParams.set("forceFunctionRegion",a));let u;o&&(s&&!Object.prototype.hasOwnProperty.call(s,"Content-Type")||!s)&&(typeof Blob<"u"&&o instanceof Blob||o instanceof ArrayBuffer?(l["Content-Type"]="application/octet-stream",u=o):typeof o=="string"?(l["Content-Type"]="text/plain",u=o):typeof FormData<"u"&&o instanceof FormData?u=o:(l["Content-Type"]="application/json",u=JSON.stringify(o)));const h=yield this.fetch(c.toString(),{method:i||"POST",headers:Object.assign(Object.assign(Object.assign({},l),this.headers),s),body:u}).catch(A=>{throw new Sr(A)}),p=h.headers.get("x-relay-error");if(p&&p==="true")throw new mt(h);if(!h.ok)throw new bt(h);let g=((r=h.headers.get("Content-Type"))!==null&&r!==void 0?r:"text/plain").split(";")[0].trim(),k;return g==="application/json"?k=yield h.json():g==="application/octet-stream"?k=yield h.blob():g==="text/event-stream"?k=h:g==="multipart/form-data"?k=yield h.formData():k=yield h.text(),{data:k,error:null,response:h}}catch(s){return{data:null,error:s,response:s instanceof bt||s instanceof mt?s.context:void 0}}})}}var q={},le={},ce={},ue={},he={},de={},Tr=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")},be=Tr();const Ar=be.fetch,Gt=be.fetch.bind(be),Vt=be.Headers,Cr=be.Request,Or=be.Response,ke=Object.freeze(Object.defineProperty({__proto__:null,Headers:Vt,Request:Cr,Response:Or,default:Gt,fetch:Ar},Symbol.toStringTag,{value:"Module"})),Pr=Kt(ke);var Fe={},kt;function Yt(){if(kt)return Fe;kt=1,Object.defineProperty(Fe,"__esModule",{value:!0});class n extends Error{constructor(t){super(t.message),this.name="PostgrestError",this.details=t.details,this.hint=t.hint,this.code=t.code}}return Fe.default=n,Fe}var St;function Xt(){if(St)return de;St=1;var n=de&&de.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(de,"__esModule",{value:!0});const e=n(Pr),t=n(Yt());class r{constructor(i){var o,l;this.shouldThrowOnError=!1,this.method=i.method,this.url=i.url,this.headers=new Headers(i.headers),this.schema=i.schema,this.body=i.body,this.shouldThrowOnError=(o=i.shouldThrowOnError)!==null&&o!==void 0?o:!1,this.signal=i.signal,this.isMaybeSingle=(l=i.isMaybeSingle)!==null&&l!==void 0?l:!1,i.fetch?this.fetch=i.fetch:typeof fetch>"u"?this.fetch=e.default:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(i,o){return this.headers=new Headers(this.headers),this.headers.set(i,o),this}then(i,o){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");const l=this.fetch;let a=l(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async c=>{var u,h,p,g;let k=null,A=null,T=null,$=c.status,F=c.statusText;if(c.ok){if(this.method!=="HEAD"){const d=await c.text();d===""||(this.headers.get("Accept")==="text/csv"||this.headers.get("Accept")&&(!((u=this.headers.get("Accept"))===null||u===void 0)&&u.includes("application/vnd.pgrst.plan+text"))?A=d:A=JSON.parse(d))}const C=(h=this.headers.get("Prefer"))===null||h===void 0?void 0:h.match(/count=(exact|planned|estimated)/),I=(p=c.headers.get("content-range"))===null||p===void 0?void 0:p.split("/");C&&I&&I.length>1&&(T=parseInt(I[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(A)&&(A.length>1?(k={code:"PGRST116",details:`Results contain ${A.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},A=null,T=null,$=406,F="Not Acceptable"):A.length===1?A=A[0]:A=null)}else{const C=await c.text();try{k=JSON.parse(C),Array.isArray(k)&&c.status===404&&(A=[],k=null,$=200,F="OK")}catch{c.status===404&&C===""?($=204,F="No Content"):k={message:C}}if(k&&this.isMaybeSingle&&(!((g=k?.details)===null||g===void 0)&&g.includes("0 rows"))&&(k=null,$=200,F="OK"),k&&this.shouldThrowOnError)throw new t.default(k)}return{error:k,data:A,count:T,status:$,statusText:F}});return this.shouldThrowOnError||(a=a.catch(c=>{var u,h,p;return{error:{message:`${(u=c?.name)!==null&&u!==void 0?u:"FetchError"}: ${c?.message}`,details:`${(h=c?.stack)!==null&&h!==void 0?h:""}`,hint:"",code:`${(p=c?.code)!==null&&p!==void 0?p:""}`},data:null,count:null,status:0,statusText:""}})),a.then(i,o)}returns(){return this}overrideTypes(){return this}}return de.default=r,de}var Et;function Qt(){if(Et)return he;Et=1;var n=he&&he.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(he,"__esModule",{value:!0});const e=n(Xt());class t extends e.default{select(s){let i=!1;const o=(s??"*").split("").map(l=>/\s/.test(l)&&!i?"":(l==='"'&&(i=!i),l)).join("");return this.url.searchParams.set("select",o),this.headers.append("Prefer","return=representation"),this}order(s,{ascending:i=!0,nullsFirst:o,foreignTable:l,referencedTable:a=l}={}){const c=a?`${a}.order`:"order",u=this.url.searchParams.get(c);return this.url.searchParams.set(c,`${u?`${u},`:""}${s}.${i?"asc":"desc"}${o===void 0?"":o?".nullsfirst":".nullslast"}`),this}limit(s,{foreignTable:i,referencedTable:o=i}={}){const l=typeof o>"u"?"limit":`${o}.limit`;return this.url.searchParams.set(l,`${s}`),this}range(s,i,{foreignTable:o,referencedTable:l=o}={}){const a=typeof l>"u"?"offset":`${l}.offset`,c=typeof l>"u"?"limit":`${l}.limit`;return this.url.searchParams.set(a,`${s}`),this.url.searchParams.set(c,`${i-s+1}`),this}abortSignal(s){return this.signal=s,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:s=!1,verbose:i=!1,settings:o=!1,buffers:l=!1,wal:a=!1,format:c="text"}={}){var u;const h=[s?"analyze":null,i?"verbose":null,o?"settings":null,l?"buffers":null,a?"wal":null].filter(Boolean).join("|"),p=(u=this.headers.get("Accept"))!==null&&u!==void 0?u:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${c}; for="${p}"; options=${h};`),c==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(s){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${s}`),this}}return he.default=t,he}var xt;function ft(){if(xt)return ue;xt=1;var n=ue&&ue.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(ue,"__esModule",{value:!0});const e=n(Qt());class t extends e.default{eq(s,i){return this.url.searchParams.append(s,`eq.${i}`),this}neq(s,i){return this.url.searchParams.append(s,`neq.${i}`),this}gt(s,i){return this.url.searchParams.append(s,`gt.${i}`),this}gte(s,i){return this.url.searchParams.append(s,`gte.${i}`),this}lt(s,i){return this.url.searchParams.append(s,`lt.${i}`),this}lte(s,i){return this.url.searchParams.append(s,`lte.${i}`),this}like(s,i){return this.url.searchParams.append(s,`like.${i}`),this}likeAllOf(s,i){return this.url.searchParams.append(s,`like(all).{${i.join(",")}}`),this}likeAnyOf(s,i){return this.url.searchParams.append(s,`like(any).{${i.join(",")}}`),this}ilike(s,i){return this.url.searchParams.append(s,`ilike.${i}`),this}ilikeAllOf(s,i){return this.url.searchParams.append(s,`ilike(all).{${i.join(",")}}`),this}ilikeAnyOf(s,i){return this.url.searchParams.append(s,`ilike(any).{${i.join(",")}}`),this}is(s,i){return this.url.searchParams.append(s,`is.${i}`),this}in(s,i){const o=Array.from(new Set(i)).map(l=>typeof l=="string"&&new RegExp("[,()]").test(l)?`"${l}"`:`${l}`).join(",");return this.url.searchParams.append(s,`in.(${o})`),this}contains(s,i){return typeof i=="string"?this.url.searchParams.append(s,`cs.${i}`):Array.isArray(i)?this.url.searchParams.append(s,`cs.{${i.join(",")}}`):this.url.searchParams.append(s,`cs.${JSON.stringify(i)}`),this}containedBy(s,i){return typeof i=="string"?this.url.searchParams.append(s,`cd.${i}`):Array.isArray(i)?this.url.searchParams.append(s,`cd.{${i.join(",")}}`):this.url.searchParams.append(s,`cd.${JSON.stringify(i)}`),this}rangeGt(s,i){return this.url.searchParams.append(s,`sr.${i}`),this}rangeGte(s,i){return this.url.searchParams.append(s,`nxl.${i}`),this}rangeLt(s,i){return this.url.searchParams.append(s,`sl.${i}`),this}rangeLte(s,i){return this.url.searchParams.append(s,`nxr.${i}`),this}rangeAdjacent(s,i){return this.url.searchParams.append(s,`adj.${i}`),this}overlaps(s,i){return typeof i=="string"?this.url.searchParams.append(s,`ov.${i}`):this.url.searchParams.append(s,`ov.{${i.join(",")}}`),this}textSearch(s,i,{config:o,type:l}={}){let a="";l==="plain"?a="pl":l==="phrase"?a="ph":l==="websearch"&&(a="w");const c=o===void 0?"":`(${o})`;return this.url.searchParams.append(s,`${a}fts${c}.${i}`),this}match(s){return Object.entries(s).forEach(([i,o])=>{this.url.searchParams.append(i,`eq.${o}`)}),this}not(s,i,o){return this.url.searchParams.append(s,`not.${i}.${o}`),this}or(s,{foreignTable:i,referencedTable:o=i}={}){const l=o?`${o}.or`:"or";return this.url.searchParams.append(l,`(${s})`),this}filter(s,i,o){return this.url.searchParams.append(s,`${i}.${o}`),this}}return ue.default=t,ue}var Tt;function Zt(){if(Tt)return ce;Tt=1;var n=ce&&ce.__importDefault||function(r){return r&&r.__esModule?r:{default:r}};Object.defineProperty(ce,"__esModule",{value:!0});const e=n(ft());class t{constructor(s,{headers:i={},schema:o,fetch:l}){this.url=s,this.headers=new Headers(i),this.schema=o,this.fetch=l}select(s,{head:i=!1,count:o}={}){const l=i?"HEAD":"GET";let a=!1;const c=(s??"*").split("").map(u=>/\s/.test(u)&&!a?"":(u==='"'&&(a=!a),u)).join("");return this.url.searchParams.set("select",c),o&&this.headers.append("Prefer",`count=${o}`),new e.default({method:l,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch})}insert(s,{count:i,defaultToNull:o=!0}={}){var l;const a="POST";if(i&&this.headers.append("Prefer",`count=${i}`),o||this.headers.append("Prefer","missing=default"),Array.isArray(s)){const c=s.reduce((u,h)=>u.concat(Object.keys(h)),[]);if(c.length>0){const u=[...new Set(c)].map(h=>`"${h}"`);this.url.searchParams.set("columns",u.join(","))}}return new e.default({method:a,url:this.url,headers:this.headers,schema:this.schema,body:s,fetch:(l=this.fetch)!==null&&l!==void 0?l:fetch})}upsert(s,{onConflict:i,ignoreDuplicates:o=!1,count:l,defaultToNull:a=!0}={}){var c;const u="POST";if(this.headers.append("Prefer",`resolution=${o?"ignore":"merge"}-duplicates`),i!==void 0&&this.url.searchParams.set("on_conflict",i),l&&this.headers.append("Prefer",`count=${l}`),a||this.headers.append("Prefer","missing=default"),Array.isArray(s)){const h=s.reduce((p,g)=>p.concat(Object.keys(g)),[]);if(h.length>0){const p=[...new Set(h)].map(g=>`"${g}"`);this.url.searchParams.set("columns",p.join(","))}}return new e.default({method:u,url:this.url,headers:this.headers,schema:this.schema,body:s,fetch:(c=this.fetch)!==null&&c!==void 0?c:fetch})}update(s,{count:i}={}){var o;const l="PATCH";return i&&this.headers.append("Prefer",`count=${i}`),new e.default({method:l,url:this.url,headers:this.headers,schema:this.schema,body:s,fetch:(o=this.fetch)!==null&&o!==void 0?o:fetch})}delete({count:s}={}){var i;const o="DELETE";return s&&this.headers.append("Prefer",`count=${s}`),new e.default({method:o,url:this.url,headers:this.headers,schema:this.schema,fetch:(i=this.fetch)!==null&&i!==void 0?i:fetch})}}return ce.default=t,ce}var At;function jr(){if(At)return le;At=1;var n=le&&le.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(le,"__esModule",{value:!0});const e=n(Zt()),t=n(ft());class r{constructor(i,{headers:o={},schema:l,fetch:a}={}){this.url=i,this.headers=new Headers(o),this.schemaName=l,this.fetch=a}from(i){const o=new URL(`${this.url}/${i}`);return new e.default(o,{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch})}schema(i){return new r(this.url,{headers:this.headers,schema:i,fetch:this.fetch})}rpc(i,o={},{head:l=!1,get:a=!1,count:c}={}){var u;let h;const p=new URL(`${this.url}/rpc/${i}`);let g;l||a?(h=l?"HEAD":"GET",Object.entries(o).filter(([A,T])=>T!==void 0).map(([A,T])=>[A,Array.isArray(T)?`{${T.join(",")}}`:`${T}`]).forEach(([A,T])=>{p.searchParams.append(A,T)})):(h="POST",g=o);const k=new Headers(this.headers);return c&&k.set("Prefer",`count=${c}`),new t.default({method:h,url:p,headers:k,schema:this.schemaName,body:g,fetch:(u=this.fetch)!==null&&u!==void 0?u:fetch})}}return le.default=r,le}var Ct;function Rr(){if(Ct)return q;Ct=1;var n=q&&q.__importDefault||function(l){return l&&l.__esModule?l:{default:l}};Object.defineProperty(q,"__esModule",{value:!0}),q.PostgrestError=q.PostgrestBuilder=q.PostgrestTransformBuilder=q.PostgrestFilterBuilder=q.PostgrestQueryBuilder=q.PostgrestClient=void 0;const e=n(jr());q.PostgrestClient=e.default;const t=n(Zt());q.PostgrestQueryBuilder=t.default;const r=n(ft());q.PostgrestFilterBuilder=r.default;const s=n(Qt());q.PostgrestTransformBuilder=s.default;const i=n(Xt());q.PostgrestBuilder=i.default;const o=n(Yt());return q.PostgrestError=o.default,q.default={PostgrestClient:e.default,PostgrestQueryBuilder:t.default,PostgrestFilterBuilder:r.default,PostgrestTransformBuilder:s.default,PostgrestBuilder:i.default,PostgrestError:o.default},q}var $r=Rr();const Ir=pr($r),{PostgrestClient:Fr,PostgrestQueryBuilder:Pi,PostgrestFilterBuilder:ji,PostgrestTransformBuilder:Ri,PostgrestBuilder:$i,PostgrestError:Ii}=Ir;class Ur{static detectEnvironment(){var e;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((e=navigator.userAgent)===null||e===void 0)&&e.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};if(typeof process<"u"){const t=process.versions;if(t&&t.node){const r=t.node,s=parseInt(r.replace(/^v/,"").split(".")[0]);return s>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${s} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${s} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const e=this.detectEnvironment();if(e.constructor)return e.constructor;let t=e.error||"WebSocket not supported in this environment.";throw e.workaround&&(t+=`

Suggested solution: ${e.workaround}`),new Error(t)}static createWebSocket(e,t){const r=this.getWebSocketConstructor();return new r(e,t)}static isWebSocketSupported(){try{const e=this.detectEnvironment();return e.type==="native"||e.type==="ws"}catch{return!1}}}const Dr="2.15.5",Lr=`realtime-js/${Dr}`,Nr="1.0.0",rt=1e4,Br=1e3,Mr=100;var Ce;(function(n){n[n.connecting=0]="connecting",n[n.open=1]="open",n[n.closing=2]="closing",n[n.closed=3]="closed"})(Ce||(Ce={}));var B;(function(n){n.closed="closed",n.errored="errored",n.joined="joined",n.joining="joining",n.leaving="leaving"})(B||(B={}));var K;(function(n){n.close="phx_close",n.error="phx_error",n.join="phx_join",n.reply="phx_reply",n.leave="phx_leave",n.access_token="access_token"})(K||(K={}));var st;(function(n){n.websocket="websocket"})(st||(st={}));var oe;(function(n){n.Connecting="connecting",n.Open="open",n.Closing="closing",n.Closed="closed"})(oe||(oe={}));class qr{constructor(){this.HEADER_LENGTH=1}decode(e,t){return e.constructor===ArrayBuffer?t(this._binaryDecode(e)):t(typeof e=="string"?JSON.parse(e):{})}_binaryDecode(e){const t=new DataView(e),r=new TextDecoder;return this._decodeBroadcast(e,t,r)}_decodeBroadcast(e,t,r){const s=t.getUint8(1),i=t.getUint8(2);let o=this.HEADER_LENGTH+2;const l=r.decode(e.slice(o,o+s));o=o+s;const a=r.decode(e.slice(o,o+i));o=o+i;const c=JSON.parse(r.decode(e.slice(o,e.byteLength)));return{ref:null,topic:l,event:a,payload:c}}}class er{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var D;(function(n){n.abstime="abstime",n.bool="bool",n.date="date",n.daterange="daterange",n.float4="float4",n.float8="float8",n.int2="int2",n.int4="int4",n.int4range="int4range",n.int8="int8",n.int8range="int8range",n.json="json",n.jsonb="jsonb",n.money="money",n.numeric="numeric",n.oid="oid",n.reltime="reltime",n.text="text",n.time="time",n.timestamp="timestamp",n.timestamptz="timestamptz",n.timetz="timetz",n.tsrange="tsrange",n.tstzrange="tstzrange"})(D||(D={}));const Ot=(n,e,t={})=>{var r;const s=(r=t.skipTypes)!==null&&r!==void 0?r:[];return Object.keys(e).reduce((i,o)=>(i[o]=Wr(o,n,e,s),i),{})},Wr=(n,e,t,r)=>{const s=e.find(l=>l.name===n),i=s?.type,o=t[n];return i&&!r.includes(i)?tr(i,o):it(o)},tr=(n,e)=>{if(n.charAt(0)==="_"){const t=n.slice(1,n.length);return Jr(e,t)}switch(n){case D.bool:return zr(e);case D.float4:case D.float8:case D.int2:case D.int4:case D.int8:case D.numeric:case D.oid:return Hr(e);case D.json:case D.jsonb:return Kr(e);case D.timestamp:return Gr(e);case D.abstime:case D.date:case D.daterange:case D.int4range:case D.int8range:case D.money:case D.reltime:case D.text:case D.time:case D.timestamptz:case D.timetz:case D.tsrange:case D.tstzrange:return it(e);default:return it(e)}},it=n=>n,zr=n=>{switch(n){case"t":return!0;case"f":return!1;default:return n}},Hr=n=>{if(typeof n=="string"){const e=parseFloat(n);if(!Number.isNaN(e))return e}return n},Kr=n=>{if(typeof n=="string")try{return JSON.parse(n)}catch(e){return`${e}`,n}return n},Jr=(n,e)=>{if(typeof n!="string")return n;const t=n.length-1,r=n[t];if(n[0]==="{"&&r==="}"){let i;const o=n.slice(1,t);try{i=JSON.parse("["+o+"]")}catch{i=o?o.split(","):[]}return i.map(l=>tr(e,l))}return n},Gr=n=>typeof n=="string"?n.replace(" ","T"):n,rr=n=>{let e=n;return e=e.replace(/^ws/i,"http"),e=e.replace(/(\/socket\/websocket|\/socket|\/websocket)\/?$/i,""),e.replace(/\/+$/,"")+"/api/broadcast"};class Ke{constructor(e,t,r={},s=rt){this.channel=e,this.event=t,this.payload=r,this.timeout=s,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var r;return this._hasReceived(e)&&t((r=this.receivedResp)===null||r===void 0?void 0:r.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(r=>r.status===e).forEach(r=>r.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var Pt;(function(n){n.SYNC="sync",n.JOIN="join",n.LEAVE="leave"})(Pt||(Pt={}));class Oe{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const r=t?.events||{state:"presence_state",diff:"presence_diff"};this.channel._on(r.state,{},s=>{const{onJoin:i,onLeave:o,onSync:l}=this.caller;this.joinRef=this.channel._joinRef(),this.state=Oe.syncState(this.state,s,i,o),this.pendingDiffs.forEach(a=>{this.state=Oe.syncDiff(this.state,a,i,o)}),this.pendingDiffs=[],l()}),this.channel._on(r.diff,{},s=>{const{onJoin:i,onLeave:o,onSync:l}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(s):(this.state=Oe.syncDiff(this.state,s,i,o),l())}),this.onJoin((s,i,o)=>{this.channel._trigger("presence",{event:"join",key:s,currentPresences:i,newPresences:o})}),this.onLeave((s,i,o)=>{this.channel._trigger("presence",{event:"leave",key:s,currentPresences:i,leftPresences:o})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,r,s){const i=this.cloneDeep(e),o=this.transformState(t),l={},a={};return this.map(i,(c,u)=>{o[c]||(a[c]=u)}),this.map(o,(c,u)=>{const h=i[c];if(h){const p=u.map(T=>T.presence_ref),g=h.map(T=>T.presence_ref),k=u.filter(T=>g.indexOf(T.presence_ref)<0),A=h.filter(T=>p.indexOf(T.presence_ref)<0);k.length>0&&(l[c]=k),A.length>0&&(a[c]=A)}else l[c]=u}),this.syncDiff(i,{joins:l,leaves:a},r,s)}static syncDiff(e,t,r,s){const{joins:i,leaves:o}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return r||(r=()=>{}),s||(s=()=>{}),this.map(i,(l,a)=>{var c;const u=(c=e[l])!==null&&c!==void 0?c:[];if(e[l]=this.cloneDeep(a),u.length>0){const h=e[l].map(g=>g.presence_ref),p=u.filter(g=>h.indexOf(g.presence_ref)<0);e[l].unshift(...p)}r(l,u,a)}),this.map(o,(l,a)=>{let c=e[l];if(!c)return;const u=a.map(h=>h.presence_ref);c=c.filter(h=>u.indexOf(h.presence_ref)<0),e[l]=c,s(l,c,a),c.length===0&&delete e[l]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(r=>t(r,e[r]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,r)=>{const s=e[r];return"metas"in s?t[r]=s.metas.map(i=>(i.presence_ref=i.phx_ref,delete i.phx_ref,delete i.phx_ref_prev,i)):t[r]=s,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var jt;(function(n){n.ALL="*",n.INSERT="INSERT",n.UPDATE="UPDATE",n.DELETE="DELETE"})(jt||(jt={}));var Pe;(function(n){n.BROADCAST="broadcast",n.PRESENCE="presence",n.POSTGRES_CHANGES="postgres_changes",n.SYSTEM="system"})(Pe||(Pe={}));var V;(function(n){n.SUBSCRIBED="SUBSCRIBED",n.TIMED_OUT="TIMED_OUT",n.CLOSED="CLOSED",n.CHANNEL_ERROR="CHANNEL_ERROR"})(V||(V={}));class gt{constructor(e,t={config:{}},r){this.topic=e,this.params=t,this.socket=r,this.bindings={},this.state=B.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new Ke(this,K.join,this.params,this.timeout),this.rejoinTimer=new er(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=B.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(s=>s.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=B.closed,this.socket._remove(this)}),this._onError(s=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,s),this.state=B.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=B.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",s=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,s),this.state=B.errored,this.rejoinTimer.scheduleTimeout())}),this._on(K.reply,{},(s,i)=>{this._trigger(this._replyEventName(i),s)}),this.presence=new Oe(this),this.broadcastEndpointURL=rr(this.socket.endPoint),this.private=this.params.config.private||!1}subscribe(e,t=this.timeout){var r,s,i;if(this.socket.isConnected()||this.socket.connect(),this.state==B.closed){const{config:{broadcast:o,presence:l,private:a}}=this.params,c=(s=(r=this.bindings.postgres_changes)===null||r===void 0?void 0:r.map(g=>g.filter))!==null&&s!==void 0?s:[],u=!!this.bindings[Pe.PRESENCE]&&this.bindings[Pe.PRESENCE].length>0||((i=this.params.config.presence)===null||i===void 0?void 0:i.enabled)===!0,h={},p={broadcast:o,presence:Object.assign(Object.assign({},l),{enabled:u}),postgres_changes:c,private:a};this.socket.accessTokenValue&&(h.access_token=this.socket.accessTokenValue),this._onError(g=>e?.(V.CHANNEL_ERROR,g)),this._onClose(()=>e?.(V.CLOSED)),this.updateJoinPayload(Object.assign({config:p},h)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:g})=>{var k;if(this.socket.setAuth(),g===void 0){e?.(V.SUBSCRIBED);return}else{const A=this.bindings.postgres_changes,T=(k=A?.length)!==null&&k!==void 0?k:0,$=[];for(let F=0;F<T;F++){const S=A[F],{filter:{event:C,schema:I,table:d,filter:y}}=S,v=g&&g[F];if(v&&v.event===C&&v.schema===I&&v.table===d&&v.filter===y)$.push(Object.assign(Object.assign({},S),{id:v.id}));else{this.unsubscribe(),this.state=B.errored,e?.(V.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=$,e&&e(V.SUBSCRIBED);return}}).receive("error",g=>{this.state=B.errored,e?.(V.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(g).join(", ")||"error")))}).receive("timeout",()=>{e?.(V.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,r){return this.state===B.joined&&e===Pe.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(()=>this.subscribe())),this._on(e,t,r)}async send(e,t={}){var r,s;if(!this._canPush()&&e.type==="broadcast"){const{event:i,payload:o}=e,a={method:"POST",headers:{Authorization:this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"",apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:i,payload:o,private:this.private}]})};try{const c=await this._fetchWithTimeout(this.broadcastEndpointURL,a,(r=t.timeout)!==null&&r!==void 0?r:this.timeout);return await((s=c.body)===null||s===void 0?void 0:s.cancel()),c.ok?"ok":"error"}catch(c){return c.name==="AbortError"?"timed out":"error"}}else return new Promise(i=>{var o,l,a;const c=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((a=(l=(o=this.params)===null||o===void 0?void 0:o.config)===null||l===void 0?void 0:l.broadcast)===null||a===void 0)&&a.ack)&&i("ok"),c.receive("ok",()=>i("ok")),c.receive("error",()=>i("error")),c.receive("timeout",()=>i("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=B.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(K.close,"leave",this._joinRef())};this.joinPush.destroy();let r=null;return new Promise(s=>{r=new Ke(this,K.leave,{},e),r.receive("ok",()=>{t(),s("ok")}).receive("timeout",()=>{t(),s("timed out")}).receive("error",()=>{s("error")}),r.send(),this._canPush()||r.trigger("ok",{})}).finally(()=>{r?.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=B.closed,this.bindings={}}async _fetchWithTimeout(e,t,r){const s=new AbortController,i=setTimeout(()=>s.abort(),r),o=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:s.signal}));return clearTimeout(i),o}_push(e,t,r=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let s=new Ke(this,e,t,r);return this._canPush()?s.send():this._addToPushBuffer(s),s}_addToPushBuffer(e){if(e.startTimeout(),this.pushBuffer.push(e),this.pushBuffer.length>Mr){const t=this.pushBuffer.shift();t&&(t.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${t.event}`,t.payload))}}_onMessage(e,t,r){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,r){var s,i;const o=e.toLocaleLowerCase(),{close:l,error:a,leave:c,join:u}=K;if(r&&[l,a,c,u].indexOf(o)>=0&&r!==this._joinRef())return;let p=this._onMessage(o,t,r);if(t&&!p)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(o)?(s=this.bindings.postgres_changes)===null||s===void 0||s.filter(g=>{var k,A,T;return((k=g.filter)===null||k===void 0?void 0:k.event)==="*"||((T=(A=g.filter)===null||A===void 0?void 0:A.event)===null||T===void 0?void 0:T.toLocaleLowerCase())===o}).map(g=>g.callback(p,r)):(i=this.bindings[o])===null||i===void 0||i.filter(g=>{var k,A,T,$,F,S;if(["broadcast","presence","postgres_changes"].includes(o))if("id"in g){const C=g.id,I=(k=g.filter)===null||k===void 0?void 0:k.event;return C&&((A=t.ids)===null||A===void 0?void 0:A.includes(C))&&(I==="*"||I?.toLocaleLowerCase()===((T=t.data)===null||T===void 0?void 0:T.type.toLocaleLowerCase()))}else{const C=(F=($=g?.filter)===null||$===void 0?void 0:$.event)===null||F===void 0?void 0:F.toLocaleLowerCase();return C==="*"||C===((S=t?.event)===null||S===void 0?void 0:S.toLocaleLowerCase())}else return g.type.toLocaleLowerCase()===o}).map(g=>{if(typeof p=="object"&&"ids"in p){const k=p.data,{schema:A,table:T,commit_timestamp:$,type:F,errors:S}=k;p=Object.assign(Object.assign({},{schema:A,table:T,commit_timestamp:$,eventType:F,new:{},old:{},errors:S}),this._getPayloadRecords(k))}g.callback(p,r)})}_isClosed(){return this.state===B.closed}_isJoined(){return this.state===B.joined}_isJoining(){return this.state===B.joining}_isLeaving(){return this.state===B.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,r){const s=e.toLocaleLowerCase(),i={type:s,filter:t,callback:r};return this.bindings[s]?this.bindings[s].push(i):this.bindings[s]=[i],this}_off(e,t){const r=e.toLocaleLowerCase();return this.bindings[r]&&(this.bindings[r]=this.bindings[r].filter(s=>{var i;return!(((i=s.type)===null||i===void 0?void 0:i.toLocaleLowerCase())===r&&gt.isEqual(s.filter,t))})),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const r in e)if(e[r]!==t[r])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(K.close,{},e)}_onError(e){this._on(K.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=B.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=Ot(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=Ot(e.columns,e.old_record)),t}}const Je=()=>{},Ue={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},Vr=[1e3,2e3,5e3,1e4],Yr=1e4,Xr=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class Qr{constructor(e,t){var r;if(this.accessTokenValue=null,this.apiKey=null,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=rt,this.transport=null,this.heartbeatIntervalMs=Ue.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=Je,this.ref=0,this.reconnectTimer=null,this.logger=Je,this.conn=null,this.sendBuffer=[],this.serializer=new qr,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._resolveFetch=s=>{let i;return s?i=s:typeof fetch>"u"?i=(...o)=>Re(async()=>{const{default:l}=await Promise.resolve().then(()=>ke);return{default:l}},void 0).then(({default:l})=>l(...o)).catch(l=>{throw new Error(`Failed to load @supabase/node-fetch: ${l.message}. This is required for HTTP requests in Node.js environments without native fetch.`)}):i=fetch,(...o)=>i(...o)},!(!((r=t?.params)===null||r===void 0)&&r.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=t.params.apikey,this.endPoint=`${e}/${st.websocket}`,this.httpEndpoint=rr(e),this._initializeOptions(t),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(t?.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=Ur.createWebSocket(this.endpointURL())}catch(e){this._setConnectionState("disconnected");const t=e.message;throw t.includes("Node.js")?new Error(`${t}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${t}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:Nr}))}disconnect(e,t){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const r=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(r),this._setConnectionState("disconnected")},e?this.conn.close(e,t??""):this.conn.close(),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,t,r){this.logger(e,t,r)}connectionState(){switch(this.conn&&this.conn.readyState){case Ce.connecting:return oe.Connecting;case Ce.open:return oe.Open;case Ce.closing:return oe.Closing;default:return oe.Closed}}isConnected(){return this.connectionState()===oe.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(e,t={config:{}}){const r=`realtime:${e}`,s=this.getChannels().find(i=>i.topic===r);if(s)return s;{const i=new gt(`realtime:${e}`,t,this);return this.channels.push(i),i}}push(e){const{topic:t,event:r,payload:s,ref:i}=e,o=()=>{this.encode(e,l=>{var a;(a=this.conn)===null||a===void 0||a.send(l)})};this.log("push",`${t} ${r} (${i})`,s),this.isConnected()?o():this.sendBuffer.push(o)}async setAuth(e=null){this._authPromise=this._performAuth(e);try{await this._authPromise}finally{this._authPromise=null}}async sendHeartbeat(){var e;if(!this.isConnected()){try{this.heartbeatCallback("disconnected")}catch(t){this.log("error","error in heartbeat callback",t)}return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(t){this.log("error","error in heartbeat callback",t)}this._wasManualDisconnect=!1,(e=this.conn)===null||e===void 0||e.close(Br,"heartbeat timeout"),setTimeout(()=>{var t;this.isConnected()||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout()},Ue.HEARTBEAT_TIMEOUT_FALLBACK);return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(t){this.log("error","error in heartbeat callback",t)}this._setAuthSafely("heartbeat")}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(r=>r.topic===e&&(r._isJoined()||r._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t.topic!==e.topic)}_onConnMessage(e){this.decode(e.data,t=>{if(t.topic==="phoenix"&&t.event==="phx_reply")try{this.heartbeatCallback(t.payload.status==="ok"?"ok":"error")}catch(c){this.log("error","error in heartbeat callback",c)}t.ref&&t.ref===this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null);const{topic:r,event:s,payload:i,ref:o}=t,l=o?`(${o})`:"",a=i.status||"";this.log("receive",`${a} ${r} ${s} ${l}`.trim(),i),this.channels.filter(c=>c._isMember(r)).forEach(c=>c._trigger(s,i,o)),this._triggerStateCallbacks("message",t)})}_clearTimer(e){var t;e==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):e==="reconnect"&&((t=this.reconnectTimer)===null||t===void 0||t.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_teardownConnection(){this.conn&&(this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null),this._clearAllTimers(),this.channels.forEach(e=>e.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),this.flushSendBuffer(),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this.workerRef.terminate()},this.workerRef.onmessage=t=>{t.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_onConnClose(e){var t;this._setConnectionState("disconnected"),this.log("transport","close",e),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout(),this._triggerStateCallbacks("close",e)}_onConnError(e){this._setConnectionState("disconnected"),this.log("transport",`${e}`),this._triggerChanError(),this._triggerStateCallbacks("error",e)}_triggerChanError(){this.channels.forEach(e=>e._trigger(K.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const r=e.match(/\?/)?"&":"?",s=new URLSearchParams(t);return`${e}${r}${s}`}_workerObjectUrl(e){let t;if(e)t=e;else{const r=new Blob([Xr],{type:"application/javascript"});t=URL.createObjectURL(r)}return t}_setConnectionState(e,t=!1){this._connectionState=e,e==="connecting"?this._wasManualDisconnect=!1:e==="disconnecting"&&(this._wasManualDisconnect=t)}async _performAuth(e=null){let t;e?t=e:this.accessToken?t=await this.accessToken():t=this.accessTokenValue,this.accessTokenValue!=t&&(this.accessTokenValue=t,this.channels.forEach(r=>{const s={access_token:t,version:Lr};t&&r.updateJoinPayload(s),r.joinedOnce&&r._isJoined()&&r._push(K.access_token,{access_token:t})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(e="general"){this.setAuth().catch(t=>{this.log("error",`error setting auth in ${e}`,t)})}_triggerStateCallbacks(e,t){try{this.stateChangeCallbacks[e].forEach(r=>{try{r(t)}catch(s){this.log("error",`error in ${e} callback`,s)}})}catch(r){this.log("error",`error triggering ${e} callbacks`,r)}}_setupReconnectionTimer(){this.reconnectTimer=new er(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},Ue.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(e){var t,r,s,i,o,l,a,c,u;if(this.transport=(t=e?.transport)!==null&&t!==void 0?t:null,this.timeout=(r=e?.timeout)!==null&&r!==void 0?r:rt,this.heartbeatIntervalMs=(s=e?.heartbeatIntervalMs)!==null&&s!==void 0?s:Ue.HEARTBEAT_INTERVAL,this.worker=(i=e?.worker)!==null&&i!==void 0?i:!1,this.accessToken=(o=e?.accessToken)!==null&&o!==void 0?o:null,this.heartbeatCallback=(l=e?.heartbeatCallback)!==null&&l!==void 0?l:Je,e?.params&&(this.params=e.params),e?.logger&&(this.logger=e.logger),(e?.logLevel||e?.log_level)&&(this.logLevel=e.logLevel||e.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(a=e?.reconnectAfterMs)!==null&&a!==void 0?a:(h=>Vr[h-1]||Yr),this.encode=(c=e?.encode)!==null&&c!==void 0?c:((h,p)=>p(JSON.stringify(h))),this.decode=(u=e?.decode)!==null&&u!==void 0?u:this.serializer.decode.bind(this.serializer),this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=e?.workerUrl}}}class pt extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function M(n){return typeof n=="object"&&n!==null&&"__isStorageError"in n}class Zr extends pt{constructor(e,t,r){super(e),this.name="StorageApiError",this.status=t,this.statusCode=r}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}}class nt extends pt{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}var es=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function l(u){try{c(r.next(u))}catch(h){o(h)}}function a(u){try{c(r.throw(u))}catch(h){o(h)}}function c(u){u.done?i(u.value):s(u.value).then(l,a)}c((r=r.apply(n,e||[])).next())})};const sr=n=>{let e;return n?e=n:typeof fetch>"u"?e=(...t)=>Re(async()=>{const{default:r}=await Promise.resolve().then(()=>ke);return{default:r}},void 0).then(({default:r})=>r(...t)):e=fetch,(...t)=>e(...t)},ts=()=>es(void 0,void 0,void 0,function*(){return typeof Response>"u"?(yield Re(()=>Promise.resolve().then(()=>ke),void 0)).Response:Response}),ot=n=>{if(Array.isArray(n))return n.map(t=>ot(t));if(typeof n=="function"||n!==Object(n))return n;const e={};return Object.entries(n).forEach(([t,r])=>{const s=t.replace(/([-_][a-z])/gi,i=>i.toUpperCase().replace(/[-_]/g,""));e[s]=ot(r)}),e},rs=n=>{if(typeof n!="object"||n===null)return!1;const e=Object.getPrototypeOf(n);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in n)&&!(Symbol.iterator in n)};var ae=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function l(u){try{c(r.next(u))}catch(h){o(h)}}function a(u){try{c(r.throw(u))}catch(h){o(h)}}function c(u){u.done?i(u.value):s(u.value).then(l,a)}c((r=r.apply(n,e||[])).next())})};const Ge=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),ss=(n,e,t)=>ae(void 0,void 0,void 0,function*(){const r=yield ts();n instanceof r&&!t?.noResolveJson?n.json().then(s=>{const i=n.status||500,o=s?.statusCode||i+"";e(new Zr(Ge(s),i,o))}).catch(s=>{e(new nt(Ge(s),s))}):e(new nt(Ge(n),n))}),is=(n,e,t,r)=>{const s={method:n,headers:e?.headers||{}};return n==="GET"||!r?s:(rs(r)?(s.headers=Object.assign({"Content-Type":"application/json"},e?.headers),s.body=JSON.stringify(r)):s.body=r,e?.duplex&&(s.duplex=e.duplex),Object.assign(Object.assign({},s),t))};function $e(n,e,t,r,s,i){return ae(this,void 0,void 0,function*(){return new Promise((o,l)=>{n(t,is(e,r,s,i)).then(a=>{if(!a.ok)throw a;return r?.noResolveJson?a:a.json()}).then(a=>o(a)).catch(a=>ss(a,l,r))})})}function Be(n,e,t,r){return ae(this,void 0,void 0,function*(){return $e(n,"GET",e,t,r)})}function J(n,e,t,r,s){return ae(this,void 0,void 0,function*(){return $e(n,"POST",e,r,s,t)})}function at(n,e,t,r,s){return ae(this,void 0,void 0,function*(){return $e(n,"PUT",e,r,s,t)})}function ns(n,e,t,r){return ae(this,void 0,void 0,function*(){return $e(n,"HEAD",e,Object.assign(Object.assign({},t),{noResolveJson:!0}),r)})}function ir(n,e,t,r,s){return ae(this,void 0,void 0,function*(){return $e(n,"DELETE",e,r,s,t)})}var W=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function l(u){try{c(r.next(u))}catch(h){o(h)}}function a(u){try{c(r.throw(u))}catch(h){o(h)}}function c(u){u.done?i(u.value):s(u.value).then(l,a)}c((r=r.apply(n,e||[])).next())})};const os={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},Rt={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class as{constructor(e,t={},r,s){this.shouldThrowOnError=!1,this.url=e,this.headers=t,this.bucketId=r,this.fetch=sr(s)}throwOnError(){return this.shouldThrowOnError=!0,this}uploadOrUpdate(e,t,r,s){return W(this,void 0,void 0,function*(){try{let i;const o=Object.assign(Object.assign({},Rt),s);let l=Object.assign(Object.assign({},this.headers),e==="POST"&&{"x-upsert":String(o.upsert)});const a=o.metadata;typeof Blob<"u"&&r instanceof Blob?(i=new FormData,i.append("cacheControl",o.cacheControl),a&&i.append("metadata",this.encodeMetadata(a)),i.append("",r)):typeof FormData<"u"&&r instanceof FormData?(i=r,i.append("cacheControl",o.cacheControl),a&&i.append("metadata",this.encodeMetadata(a))):(i=r,l["cache-control"]=`max-age=${o.cacheControl}`,l["content-type"]=o.contentType,a&&(l["x-metadata"]=this.toBase64(this.encodeMetadata(a)))),s?.headers&&(l=Object.assign(Object.assign({},l),s.headers));const c=this._removeEmptyFolders(t),u=this._getFinalPath(c),h=yield(e=="PUT"?at:J)(this.fetch,`${this.url}/object/${u}`,i,Object.assign({headers:l},o?.duplex?{duplex:o.duplex}:{}));return{data:{path:c,id:h.Id,fullPath:h.Key},error:null}}catch(i){if(this.shouldThrowOnError)throw i;if(M(i))return{data:null,error:i};throw i}})}upload(e,t,r){return W(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,r)})}uploadToSignedUrl(e,t,r,s){return W(this,void 0,void 0,function*(){const i=this._removeEmptyFolders(e),o=this._getFinalPath(i),l=new URL(this.url+`/object/upload/sign/${o}`);l.searchParams.set("token",t);try{let a;const c=Object.assign({upsert:Rt.upsert},s),u=Object.assign(Object.assign({},this.headers),{"x-upsert":String(c.upsert)});typeof Blob<"u"&&r instanceof Blob?(a=new FormData,a.append("cacheControl",c.cacheControl),a.append("",r)):typeof FormData<"u"&&r instanceof FormData?(a=r,a.append("cacheControl",c.cacheControl)):(a=r,u["cache-control"]=`max-age=${c.cacheControl}`,u["content-type"]=c.contentType);const h=yield at(this.fetch,l.toString(),a,{headers:u});return{data:{path:i,fullPath:h.Key},error:null}}catch(a){if(this.shouldThrowOnError)throw a;if(M(a))return{data:null,error:a};throw a}})}createSignedUploadUrl(e,t){return W(this,void 0,void 0,function*(){try{let r=this._getFinalPath(e);const s=Object.assign({},this.headers);t?.upsert&&(s["x-upsert"]="true");const i=yield J(this.fetch,`${this.url}/object/upload/sign/${r}`,{},{headers:s}),o=new URL(this.url+i.url),l=o.searchParams.get("token");if(!l)throw new pt("No token returned by API");return{data:{signedUrl:o.toString(),path:e,token:l},error:null}}catch(r){if(this.shouldThrowOnError)throw r;if(M(r))return{data:null,error:r};throw r}})}update(e,t,r){return W(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,r)})}move(e,t,r){return W(this,void 0,void 0,function*(){try{return{data:yield J(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:r?.destinationBucket},{headers:this.headers}),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(M(s))return{data:null,error:s};throw s}})}copy(e,t,r){return W(this,void 0,void 0,function*(){try{return{data:{path:(yield J(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:r?.destinationBucket},{headers:this.headers})).Key},error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(M(s))return{data:null,error:s};throw s}})}createSignedUrl(e,t,r){return W(this,void 0,void 0,function*(){try{let s=this._getFinalPath(e),i=yield J(this.fetch,`${this.url}/object/sign/${s}`,Object.assign({expiresIn:t},r?.transform?{transform:r.transform}:{}),{headers:this.headers});const o=r?.download?`&download=${r.download===!0?"":r.download}`:"";return i={signedUrl:encodeURI(`${this.url}${i.signedURL}${o}`)},{data:i,error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(M(s))return{data:null,error:s};throw s}})}createSignedUrls(e,t,r){return W(this,void 0,void 0,function*(){try{const s=yield J(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),i=r?.download?`&download=${r.download===!0?"":r.download}`:"";return{data:s.map(o=>Object.assign(Object.assign({},o),{signedUrl:o.signedURL?encodeURI(`${this.url}${o.signedURL}${i}`):null})),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(M(s))return{data:null,error:s};throw s}})}download(e,t){return W(this,void 0,void 0,function*(){const s=typeof t?.transform<"u"?"render/image/authenticated":"object",i=this.transformOptsToQueryString(t?.transform||{}),o=i?`?${i}`:"";try{const l=this._getFinalPath(e);return{data:yield(yield Be(this.fetch,`${this.url}/${s}/${l}${o}`,{headers:this.headers,noResolveJson:!0})).blob(),error:null}}catch(l){if(this.shouldThrowOnError)throw l;if(M(l))return{data:null,error:l};throw l}})}info(e){return W(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{const r=yield Be(this.fetch,`${this.url}/object/info/${t}`,{headers:this.headers});return{data:ot(r),error:null}}catch(r){if(this.shouldThrowOnError)throw r;if(M(r))return{data:null,error:r};throw r}})}exists(e){return W(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{return yield ns(this.fetch,`${this.url}/object/${t}`,{headers:this.headers}),{data:!0,error:null}}catch(r){if(this.shouldThrowOnError)throw r;if(M(r)&&r instanceof nt){const s=r.originalError;if([400,404].includes(s?.status))return{data:!1,error:r}}throw r}})}getPublicUrl(e,t){const r=this._getFinalPath(e),s=[],i=t?.download?`download=${t.download===!0?"":t.download}`:"";i!==""&&s.push(i);const l=typeof t?.transform<"u"?"render/image":"object",a=this.transformOptsToQueryString(t?.transform||{});a!==""&&s.push(a);let c=s.join("&");return c!==""&&(c=`?${c}`),{data:{publicUrl:encodeURI(`${this.url}/${l}/public/${r}${c}`)}}}remove(e){return W(this,void 0,void 0,function*(){try{return{data:yield ir(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(M(t))return{data:null,error:t};throw t}})}list(e,t,r){return W(this,void 0,void 0,function*(){try{const s=Object.assign(Object.assign(Object.assign({},os),t),{prefix:e||""});return{data:yield J(this.fetch,`${this.url}/object/list/${this.bucketId}`,s,{headers:this.headers},r),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(M(s))return{data:null,error:s};throw s}})}listV2(e,t){return W(this,void 0,void 0,function*(){try{const r=Object.assign({},e);return{data:yield J(this.fetch,`${this.url}/object/list-v2/${this.bucketId}`,r,{headers:this.headers},t),error:null}}catch(r){if(this.shouldThrowOnError)throw r;if(M(r))return{data:null,error:r};throw r}})}encodeMetadata(e){return JSON.stringify(e)}toBase64(e){return typeof Buffer<"u"?Buffer.from(e).toString("base64"):btoa(e)}_getFinalPath(e){return`${this.bucketId}/${e.replace(/^\/+/,"")}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}}const ls="2.12.1",cs={"X-Client-Info":`storage-js/${ls}`};var fe=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function l(u){try{c(r.next(u))}catch(h){o(h)}}function a(u){try{c(r.throw(u))}catch(h){o(h)}}function c(u){u.done?i(u.value):s(u.value).then(l,a)}c((r=r.apply(n,e||[])).next())})};class us{constructor(e,t={},r,s){this.shouldThrowOnError=!1;const i=new URL(e);s?.useNewHostname&&/supabase\.(co|in|red)$/.test(i.hostname)&&!i.hostname.includes("storage.supabase.")&&(i.hostname=i.hostname.replace("supabase.","storage.supabase.")),this.url=i.href,this.headers=Object.assign(Object.assign({},cs),t),this.fetch=sr(r)}throwOnError(){return this.shouldThrowOnError=!0,this}listBuckets(){return fe(this,void 0,void 0,function*(){try{return{data:yield Be(this.fetch,`${this.url}/bucket`,{headers:this.headers}),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(M(e))return{data:null,error:e};throw e}})}getBucket(e){return fe(this,void 0,void 0,function*(){try{return{data:yield Be(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(M(t))return{data:null,error:t};throw t}})}createBucket(e,t={public:!1}){return fe(this,void 0,void 0,function*(){try{return{data:yield J(this.fetch,`${this.url}/bucket`,{id:e,name:e,type:t.type,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(r){if(this.shouldThrowOnError)throw r;if(M(r))return{data:null,error:r};throw r}})}updateBucket(e,t){return fe(this,void 0,void 0,function*(){try{return{data:yield at(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(r){if(this.shouldThrowOnError)throw r;if(M(r))return{data:null,error:r};throw r}})}emptyBucket(e){return fe(this,void 0,void 0,function*(){try{return{data:yield J(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(M(t))return{data:null,error:t};throw t}})}deleteBucket(e){return fe(this,void 0,void 0,function*(){try{return{data:yield ir(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(M(t))return{data:null,error:t};throw t}})}}class hs extends us{constructor(e,t={},r,s){super(e,t,r,s)}from(e){return new as(this.url,this.headers,e,this.fetch)}}const ds="2.57.4";let Ae="";typeof Deno<"u"?Ae="deno":typeof document<"u"?Ae="web":typeof navigator<"u"&&navigator.product==="ReactNative"?Ae="react-native":Ae="node";const fs={"X-Client-Info":`supabase-js-${Ae}/${ds}`},gs={headers:fs},ps={schema:"public"},_s={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},vs={};var ws=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function l(u){try{c(r.next(u))}catch(h){o(h)}}function a(u){try{c(r.throw(u))}catch(h){o(h)}}function c(u){u.done?i(u.value):s(u.value).then(l,a)}c((r=r.apply(n,e||[])).next())})};const ys=n=>{let e;return n?e=n:typeof fetch>"u"?e=Gt:e=fetch,(...t)=>e(...t)},ms=()=>typeof Headers>"u"?Vt:Headers,bs=(n,e,t)=>{const r=ys(t),s=ms();return(i,o)=>ws(void 0,void 0,void 0,function*(){var l;const a=(l=yield e())!==null&&l!==void 0?l:n;let c=new s(o?.headers);return c.has("apikey")||c.set("apikey",n),c.has("Authorization")||c.set("Authorization",`Bearer ${a}`),r(i,Object.assign(Object.assign({},o),{headers:c}))})};var ks=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function l(u){try{c(r.next(u))}catch(h){o(h)}}function a(u){try{c(r.throw(u))}catch(h){o(h)}}function c(u){u.done?i(u.value):s(u.value).then(l,a)}c((r=r.apply(n,e||[])).next())})};function Ss(n){return n.endsWith("/")?n:n+"/"}function Es(n,e){var t,r;const{db:s,auth:i,realtime:o,global:l}=n,{db:a,auth:c,realtime:u,global:h}=e,p={db:Object.assign(Object.assign({},a),s),auth:Object.assign(Object.assign({},c),i),realtime:Object.assign(Object.assign({},u),o),storage:{},global:Object.assign(Object.assign(Object.assign({},h),l),{headers:Object.assign(Object.assign({},(t=h?.headers)!==null&&t!==void 0?t:{}),(r=l?.headers)!==null&&r!==void 0?r:{})}),accessToken:()=>ks(this,void 0,void 0,function*(){return""})};return n.accessToken?p.accessToken=n.accessToken:delete p.accessToken,p}function xs(n){const e=n?.trim();if(!e)throw new Error("supabaseUrl is required.");if(!e.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(Ss(e))}catch{throw Error("Invalid supabaseUrl: Provided URL is malformed.")}}const nr="2.71.1",ye=30*1e3,lt=3,Ve=lt*ye,Ts="http://localhost:9999",As="supabase.auth.token",Cs={"X-Client-Info":`gotrue-js/${nr}`},ct="X-Supabase-Api-Version",or={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},Os=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,Ps=600*1e3;class _t extends Error{constructor(e,t,r){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=r}}function O(n){return typeof n=="object"&&n!==null&&"__isAuthError"in n}class js extends _t{constructor(e,t,r){super(e,t,r),this.name="AuthApiError",this.status=t,this.code=r}}function Rs(n){return O(n)&&n.name==="AuthApiError"}class ar extends _t{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class re extends _t{constructor(e,t,r,s){super(e,r,s),this.name=t,this.status=r}}class ee extends re{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function $s(n){return O(n)&&n.name==="AuthSessionMissingError"}class De extends re{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class Le extends re{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class Ne extends re{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function Is(n){return O(n)&&n.name==="AuthImplicitGrantRedirectError"}class $t extends re{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class ut extends re{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}function Ye(n){return O(n)&&n.name==="AuthRetryableFetchError"}class It extends re{constructor(e,t,r){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=r}}class ht extends re{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const Me="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),Ft=` 	
\r=`.split(""),Fs=(()=>{const n=new Array(128);for(let e=0;e<n.length;e+=1)n[e]=-1;for(let e=0;e<Ft.length;e+=1)n[Ft[e].charCodeAt(0)]=-2;for(let e=0;e<Me.length;e+=1)n[Me[e].charCodeAt(0)]=e;return n})();function Ut(n,e,t){if(n!==null)for(e.queue=e.queue<<8|n,e.queuedBits+=8;e.queuedBits>=6;){const r=e.queue>>e.queuedBits-6&63;t(Me[r]),e.queuedBits-=6}else if(e.queuedBits>0)for(e.queue=e.queue<<6-e.queuedBits,e.queuedBits=6;e.queuedBits>=6;){const r=e.queue>>e.queuedBits-6&63;t(Me[r]),e.queuedBits-=6}}function lr(n,e,t){const r=Fs[n];if(r>-1)for(e.queue=e.queue<<6|r,e.queuedBits+=6;e.queuedBits>=8;)t(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(r===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(n)}"`)}}function Dt(n){const e=[],t=o=>{e.push(String.fromCodePoint(o))},r={utf8seq:0,codepoint:0},s={queue:0,queuedBits:0},i=o=>{Ls(o,r,t)};for(let o=0;o<n.length;o+=1)lr(n.charCodeAt(o),s,i);return e.join("")}function Us(n,e){if(n<=127){e(n);return}else if(n<=2047){e(192|n>>6),e(128|n&63);return}else if(n<=65535){e(224|n>>12),e(128|n>>6&63),e(128|n&63);return}else if(n<=1114111){e(240|n>>18),e(128|n>>12&63),e(128|n>>6&63),e(128|n&63);return}throw new Error(`Unrecognized Unicode codepoint: ${n.toString(16)}`)}function Ds(n,e){for(let t=0;t<n.length;t+=1){let r=n.charCodeAt(t);if(r>55295&&r<=56319){const s=(r-55296)*1024&65535;r=(n.charCodeAt(t+1)-56320&65535|s)+65536,t+=1}Us(r,e)}}function Ls(n,e,t){if(e.utf8seq===0){if(n<=127){t(n);return}for(let r=1;r<6;r+=1)if((n>>7-r&1)===0){e.utf8seq=r;break}if(e.utf8seq===2)e.codepoint=n&31;else if(e.utf8seq===3)e.codepoint=n&15;else if(e.utf8seq===4)e.codepoint=n&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(n<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|n&63,e.utf8seq-=1,e.utf8seq===0&&t(e.codepoint)}}function Ns(n){const e=[],t={queue:0,queuedBits:0},r=s=>{e.push(s)};for(let s=0;s<n.length;s+=1)lr(n.charCodeAt(s),t,r);return new Uint8Array(e)}function Bs(n){const e=[];return Ds(n,t=>e.push(t)),new Uint8Array(e)}function Ms(n){const e=[],t={queue:0,queuedBits:0},r=s=>{e.push(s)};return n.forEach(s=>Ut(s,t,r)),Ut(null,t,r),e.join("")}function qs(n){return Math.round(Date.now()/1e3)+n}function Ws(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){const e=Math.random()*16|0;return(n=="x"?e:e&3|8).toString(16)})}const H=()=>typeof window<"u"&&typeof document<"u",se={tested:!1,writable:!1},cr=()=>{if(!H())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(se.tested)return se.writable;const n=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(n,n),globalThis.localStorage.removeItem(n),se.tested=!0,se.writable=!0}catch{se.tested=!0,se.writable=!1}return se.writable};function zs(n){const e={},t=new URL(n);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((s,i)=>{e[i]=s})}catch{}return t.searchParams.forEach((r,s)=>{e[s]=r}),e}const ur=n=>{let e;return n?e=n:typeof fetch>"u"?e=(...t)=>Re(async()=>{const{default:r}=await Promise.resolve().then(()=>ke);return{default:r}},void 0).then(({default:r})=>r(...t)):e=fetch,(...t)=>e(...t)},Hs=n=>typeof n=="object"&&n!==null&&"status"in n&&"ok"in n&&"json"in n&&typeof n.json=="function",me=async(n,e,t)=>{await n.setItem(e,JSON.stringify(t))},ie=async(n,e)=>{const t=await n.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},Z=async(n,e)=>{await n.removeItem(e)};class qe{constructor(){this.promise=new qe.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}qe.promiseConstructor=Promise;function Xe(n){const e=n.split(".");if(e.length!==3)throw new ht("Invalid JWT structure");for(let r=0;r<e.length;r++)if(!Os.test(e[r]))throw new ht("JWT not in base64url format");return{header:JSON.parse(Dt(e[0])),payload:JSON.parse(Dt(e[1])),signature:Ns(e[2]),raw:{header:e[0],payload:e[1]}}}async function Ks(n){return await new Promise(e=>{setTimeout(()=>e(null),n)})}function Js(n,e){return new Promise((r,s)=>{(async()=>{for(let i=0;i<1/0;i++)try{const o=await n(i);if(!e(i,null,o)){r(o);return}}catch(o){if(!e(i,o)){s(o);return}}})()})}function Gs(n){return("0"+n.toString(16)).substr(-2)}function Vs(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",r=t.length;let s="";for(let i=0;i<56;i++)s+=t.charAt(Math.floor(Math.random()*r));return s}return crypto.getRandomValues(e),Array.from(e,Gs).join("")}async function Ys(n){const t=new TextEncoder().encode(n),r=await crypto.subtle.digest("SHA-256",t),s=new Uint8Array(r);return Array.from(s).map(i=>String.fromCharCode(i)).join("")}async function Xs(n){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return n;const t=await Ys(n);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function ge(n,e,t=!1){const r=Vs();let s=r;t&&(s+="/PASSWORD_RECOVERY"),await me(n,`${e}-code-verifier`,s);const i=await Xs(r);return[i,r===i?"plain":"s256"]}const Qs=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function Zs(n){const e=n.headers.get(ct);if(!e||!e.match(Qs))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function ei(n){if(!n)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(n<=e)throw new Error("JWT has expired")}function ti(n){switch(n){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const ri=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function pe(n){if(!ri.test(n))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function Qe(){const n={};return new Proxy(n,{get:(e,t)=>{if(t==="__isUserNotAvailableProxy")return!0;if(typeof t=="symbol"){const r=t.toString();if(r==="Symbol(Symbol.toPrimitive)"||r==="Symbol(Symbol.toStringTag)"||r==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${t}" property of the session object is not supported. Please use getUser() instead.`)},set:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function Lt(n){return JSON.parse(JSON.stringify(n))}var si=function(n,e){var t={};for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,r=Object.getOwnPropertySymbols(n);s<r.length;s++)e.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(n,r[s])&&(t[r[s]]=n[r[s]]);return t};const ne=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),ii=[502,503,504];async function Nt(n){var e;if(!Hs(n))throw new ut(ne(n),0);if(ii.includes(n.status))throw new ut(ne(n),n.status);let t;try{t=await n.json()}catch(i){throw new ar(ne(i),i)}let r;const s=Zs(n);if(s&&s.getTime()>=or["2024-01-01"].timestamp&&typeof t=="object"&&t&&typeof t.code=="string"?r=t.code:typeof t=="object"&&t&&typeof t.error_code=="string"&&(r=t.error_code),r){if(r==="weak_password")throw new It(ne(t),n.status,((e=t.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(r==="session_not_found")throw new ee}else if(typeof t=="object"&&t&&typeof t.weak_password=="object"&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce((i,o)=>i&&typeof o=="string",!0))throw new It(ne(t),n.status,t.weak_password.reasons);throw new js(ne(t),n.status||500,r)}const ni=(n,e,t,r)=>{const s={method:n,headers:e?.headers||{}};return n==="GET"?s:(s.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e?.headers),s.body=JSON.stringify(r),Object.assign(Object.assign({},s),t))};async function R(n,e,t,r){var s;const i=Object.assign({},r?.headers);i[ct]||(i[ct]=or["2024-01-01"].name),r?.jwt&&(i.Authorization=`Bearer ${r.jwt}`);const o=(s=r?.query)!==null&&s!==void 0?s:{};r?.redirectTo&&(o.redirect_to=r.redirectTo);const l=Object.keys(o).length?"?"+new URLSearchParams(o).toString():"",a=await oi(n,e,t+l,{headers:i,noResolveJson:r?.noResolveJson},{},r?.body);return r?.xform?r?.xform(a):{data:Object.assign({},a),error:null}}async function oi(n,e,t,r,s,i){const o=ni(e,r,s,i);let l;try{l=await n(t,Object.assign({},o))}catch(a){throw console.error(a),new ut(ne(a),0)}if(l.ok||await Nt(l),r?.noResolveJson)return l;try{return await l.json()}catch(a){await Nt(a)}}function G(n){var e;let t=null;ui(n)&&(t=Object.assign({},n),n.expires_at||(t.expires_at=qs(n.expires_in)));const r=(e=n.user)!==null&&e!==void 0?e:n;return{data:{session:t,user:r},error:null}}function Bt(n){const e=G(n);return!e.error&&n.weak_password&&typeof n.weak_password=="object"&&Array.isArray(n.weak_password.reasons)&&n.weak_password.reasons.length&&n.weak_password.message&&typeof n.weak_password.message=="string"&&n.weak_password.reasons.reduce((t,r)=>t&&typeof r=="string",!0)&&(e.data.weak_password=n.weak_password),e}function te(n){var e;return{data:{user:(e=n.user)!==null&&e!==void 0?e:n},error:null}}function ai(n){return{data:n,error:null}}function li(n){const{action_link:e,email_otp:t,hashed_token:r,redirect_to:s,verification_type:i}=n,o=si(n,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),l={action_link:e,email_otp:t,hashed_token:r,redirect_to:s,verification_type:i},a=Object.assign({},o);return{data:{properties:l,user:a},error:null}}function ci(n){return n}function ui(n){return n.access_token&&n.refresh_token&&n.expires_in}const Ze=["global","local","others"];var hi=function(n,e){var t={};for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,r=Object.getOwnPropertySymbols(n);s<r.length;s++)e.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(n,r[s])&&(t[r[s]]=n[r[s]]);return t};class di{constructor({url:e="",headers:t={},fetch:r}){this.url=e,this.headers=t,this.fetch=ur(r),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)}}async signOut(e,t=Ze[0]){if(Ze.indexOf(t)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${Ze.join(", ")}`);try{return await R(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(r){if(O(r))return{data:null,error:r};throw r}}async inviteUserByEmail(e,t={}){try{return await R(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:te})}catch(r){if(O(r))return{data:{user:null},error:r};throw r}}async generateLink(e){try{const{options:t}=e,r=hi(e,["options"]),s=Object.assign(Object.assign({},r),t);return"newEmail"in r&&(s.new_email=r?.newEmail,delete s.newEmail),await R(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:s,headers:this.headers,xform:li,redirectTo:t?.redirectTo})}catch(t){if(O(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await R(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:te})}catch(t){if(O(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,r,s,i,o,l,a;try{const c={nextPage:null,lastPage:0,total:0},u=await R(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(t=e?.page)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:"",per_page:(i=(s=e?.perPage)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:""},xform:ci});if(u.error)throw u.error;const h=await u.json(),p=(o=u.headers.get("x-total-count"))!==null&&o!==void 0?o:0,g=(a=(l=u.headers.get("link"))===null||l===void 0?void 0:l.split(","))!==null&&a!==void 0?a:[];return g.length>0&&(g.forEach(k=>{const A=parseInt(k.split(";")[0].split("=")[1].substring(0,1)),T=JSON.parse(k.split(";")[1].split("=")[1]);c[`${T}Page`]=A}),c.total=parseInt(p)),{data:Object.assign(Object.assign({},h),c),error:null}}catch(c){if(O(c))return{data:{users:[]},error:c};throw c}}async getUserById(e){pe(e);try{return await R(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:te})}catch(t){if(O(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){pe(e);try{return await R(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:te})}catch(r){if(O(r))return{data:{user:null},error:r};throw r}}async deleteUser(e,t=!1){pe(e);try{return await R(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:te})}catch(r){if(O(r))return{data:{user:null},error:r};throw r}}async _listFactors(e){pe(e.userId);try{const{data:t,error:r}=await R(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:s=>({data:{factors:s},error:null})});return{data:t,error:r}}catch(t){if(O(t))return{data:null,error:t};throw t}}async _deleteFactor(e){pe(e.userId),pe(e.id);try{return{data:await R(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(O(t))return{data:null,error:t};throw t}}}function Mt(n={}){return{getItem:e=>n[e]||null,setItem:(e,t)=>{n[e]=t},removeItem:e=>{delete n[e]}}}function fi(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}const _e={debug:!!(globalThis&&cr()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class hr extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class gi extends hr{}async function pi(n,e,t){_e.debug;const r=new globalThis.AbortController;return e>0&&setTimeout(()=>{r.abort(),_e.debug},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(n,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:r.signal},async s=>{if(s){_e.debug&&s.name;try{return await t()}finally{_e.debug&&s.name}}else{if(e===0)throw _e.debug,new gi(`Acquiring an exclusive Navigator LockManager lock "${n}" immediately failed`);if(_e.debug)try{const i=await globalThis.navigator.locks.query();JSON.stringify(i,null,"  ")}catch(i){}return await t()}}))}fi();const _i={url:Ts,storageKey:As,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:Cs,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1};async function qt(n,e,t){return await t()}const ve={};class je{constructor(e){var t,r;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=je.nextInstanceID,je.nextInstanceID+=1,this.instanceID>0&&H();const s=Object.assign(Object.assign({},_i),e);if(this.logDebugMessages=!!s.debug,typeof s.debug=="function"&&(this.logger=s.debug),this.persistSession=s.persistSession,this.storageKey=s.storageKey,this.autoRefreshToken=s.autoRefreshToken,this.admin=new di({url:s.url,headers:s.headers,fetch:s.fetch}),this.url=s.url,this.headers=s.headers,this.fetch=ur(s.fetch),this.lock=s.lock||qt,this.detectSessionInUrl=s.detectSessionInUrl,this.flowType=s.flowType,this.hasCustomAuthorizationHeader=s.hasCustomAuthorizationHeader,s.lock?this.lock=s.lock:H()&&(!((t=globalThis?.navigator)===null||t===void 0)&&t.locks)?this.lock=pi:this.lock=qt,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},this.persistSession?(s.storage?this.storage=s.storage:cr()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=Mt(this.memoryStorage)),s.userStorage&&(this.userStorage=s.userStorage)):(this.memoryStorage={},this.storage=Mt(this.memoryStorage)),H()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(i){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",i)}(r=this.broadcastChannel)===null||r===void 0||r.addEventListener("message",async i=>{this._debug("received broadcast notification from other tab or client",i),await this._notifyAllSubscribers(i.data.event,i.data.session,!1)})}this.initialize()}get jwks(){var e,t;return(t=(e=ve[this.storageKey])===null||e===void 0?void 0:e.jwks)!==null&&t!==void 0?t:{keys:[]}}set jwks(e){ve[this.storageKey]=Object.assign(Object.assign({},ve[this.storageKey]),{jwks:e})}get jwks_cached_at(){var e,t;return(t=(e=ve[this.storageKey])===null||e===void 0?void 0:e.cachedAt)!==null&&t!==void 0?t:Number.MIN_SAFE_INTEGER}set jwks_cached_at(e){ve[this.storageKey]=Object.assign(Object.assign({},ve[this.storageKey]),{cachedAt:e})}_debug(...e){return this.logDebugMessages&&this.logger(`GoTrueClient@${this.instanceID} (${nr}) ${new Date().toISOString()}`,...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{const t=zs(window.location.href);let r="none";if(this._isImplicitGrantCallback(t)?r="implicit":await this._isPKCECallback(t)&&(r="pkce"),H()&&this.detectSessionInUrl&&r!=="none"){const{data:s,error:i}=await this._getSessionFromURL(t,r);if(i){if(this._debug("#_initialize()","error detecting session from URL",i),Is(i)){const a=(e=i.details)===null||e===void 0?void 0:e.code;if(a==="identity_already_exists"||a==="identity_not_found"||a==="single_identity_not_deletable")return{error:i}}return await this._removeSession(),{error:i}}const{session:o,redirectType:l}=s;return this._debug("#_initialize()","detected session in URL",o,"redirect type",l),await this._saveSession(o),setTimeout(async()=>{l==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",o):await this._notifyAllSubscribers("SIGNED_IN",o)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return O(t)?{error:t}:{error:new ar("Unexpected error during initialization",t)}}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,r,s;try{const i=await R(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(r=(t=e?.options)===null||t===void 0?void 0:t.data)!==null&&r!==void 0?r:{},gotrue_meta_security:{captcha_token:(s=e?.options)===null||s===void 0?void 0:s.captchaToken}},xform:G}),{data:o,error:l}=i;if(l||!o)return{data:{user:null,session:null},error:l};const a=o.session,c=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",a)),{data:{user:c,session:a},error:null}}catch(i){if(O(i))return{data:{user:null,session:null},error:i};throw i}}async signUp(e){var t,r,s;try{let i;if("email"in e){const{email:u,password:h,options:p}=e;let g=null,k=null;this.flowType==="pkce"&&([g,k]=await ge(this.storage,this.storageKey)),i=await R(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:p?.emailRedirectTo,body:{email:u,password:h,data:(t=p?.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:p?.captchaToken},code_challenge:g,code_challenge_method:k},xform:G})}else if("phone"in e){const{phone:u,password:h,options:p}=e;i=await R(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:u,password:h,data:(r=p?.data)!==null&&r!==void 0?r:{},channel:(s=p?.channel)!==null&&s!==void 0?s:"sms",gotrue_meta_security:{captcha_token:p?.captchaToken}},xform:G})}else throw new Le("You must provide either an email or phone number and a password");const{data:o,error:l}=i;if(l||!o)return{data:{user:null,session:null},error:l};const a=o.session,c=o.user;return o.session&&(await this._saveSession(o.session),await this._notifyAllSubscribers("SIGNED_IN",a)),{data:{user:c,session:a},error:null}}catch(i){if(O(i))return{data:{user:null,session:null},error:i};throw i}}async signInWithPassword(e){try{let t;if("email"in e){const{email:i,password:o,options:l}=e;t=await R(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:i,password:o,gotrue_meta_security:{captcha_token:l?.captchaToken}},xform:Bt})}else if("phone"in e){const{phone:i,password:o,options:l}=e;t=await R(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:i,password:o,gotrue_meta_security:{captcha_token:l?.captchaToken}},xform:Bt})}else throw new Le("You must provide either an email or phone number and a password");const{data:r,error:s}=t;return s?{data:{user:null,session:null},error:s}:!r||!r.session||!r.user?{data:{user:null,session:null},error:new De}:(r.session&&(await this._saveSession(r.session),await this._notifyAllSubscribers("SIGNED_IN",r.session)),{data:Object.assign({user:r.user,session:r.session},r.weak_password?{weakPassword:r.weak_password}:null),error:s})}catch(t){if(O(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOAuth(e){var t,r,s,i;return await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(r=e.options)===null||r===void 0?void 0:r.scopes,queryParams:(s=e.options)===null||s===void 0?void 0:s.queryParams,skipBrowserRedirect:(i=e.options)===null||i===void 0?void 0:i.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){const{chain:t}=e;if(t==="solana")return await this.signInWithSolana(e);throw new Error(`@supabase/auth-js: Unsupported chain "${t}"`)}async signInWithSolana(e){var t,r,s,i,o,l,a,c,u,h,p,g;let k,A;if("message"in e)k=e.message,A=e.signature;else{const{chain:T,wallet:$,statement:F,options:S}=e;let C;if(H())if(typeof $=="object")C=$;else{const d=window;if("solana"in d&&typeof d.solana=="object"&&("signIn"in d.solana&&typeof d.solana.signIn=="function"||"signMessage"in d.solana&&typeof d.solana.signMessage=="function"))C=d.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof $!="object"||!S?.url)throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");C=$}const I=new URL((t=S?.url)!==null&&t!==void 0?t:window.location.href);if("signIn"in C&&C.signIn){const d=await C.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},S?.signInWithSolana),{version:"1",domain:I.host,uri:I.href}),F?{statement:F}:null));let y;if(Array.isArray(d)&&d[0]&&typeof d[0]=="object")y=d[0];else if(d&&typeof d=="object"&&"signedMessage"in d&&"signature"in d)y=d;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in y&&"signature"in y&&(typeof y.signedMessage=="string"||y.signedMessage instanceof Uint8Array)&&y.signature instanceof Uint8Array)k=typeof y.signedMessage=="string"?y.signedMessage:new TextDecoder().decode(y.signedMessage),A=y.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in C)||typeof C.signMessage!="function"||!("publicKey"in C)||typeof C!="object"||!C.publicKey||!("toBase58"in C.publicKey)||typeof C.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");k=[`${I.host} wants you to sign in with your Solana account:`,C.publicKey.toBase58(),...F?["",F,""]:[""],"Version: 1",`URI: ${I.href}`,`Issued At: ${(s=(r=S?.signInWithSolana)===null||r===void 0?void 0:r.issuedAt)!==null&&s!==void 0?s:new Date().toISOString()}`,...!((i=S?.signInWithSolana)===null||i===void 0)&&i.notBefore?[`Not Before: ${S.signInWithSolana.notBefore}`]:[],...!((o=S?.signInWithSolana)===null||o===void 0)&&o.expirationTime?[`Expiration Time: ${S.signInWithSolana.expirationTime}`]:[],...!((l=S?.signInWithSolana)===null||l===void 0)&&l.chainId?[`Chain ID: ${S.signInWithSolana.chainId}`]:[],...!((a=S?.signInWithSolana)===null||a===void 0)&&a.nonce?[`Nonce: ${S.signInWithSolana.nonce}`]:[],...!((c=S?.signInWithSolana)===null||c===void 0)&&c.requestId?[`Request ID: ${S.signInWithSolana.requestId}`]:[],...!((h=(u=S?.signInWithSolana)===null||u===void 0?void 0:u.resources)===null||h===void 0)&&h.length?["Resources",...S.signInWithSolana.resources.map(y=>`- ${y}`)]:[]].join(`
`);const d=await C.signMessage(new TextEncoder().encode(k),"utf8");if(!d||!(d instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");A=d}}try{const{data:T,error:$}=await R(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:k,signature:Ms(A)},!((p=e.options)===null||p===void 0)&&p.captchaToken?{gotrue_meta_security:{captcha_token:(g=e.options)===null||g===void 0?void 0:g.captchaToken}}:null),xform:G});if($)throw $;return!T||!T.session||!T.user?{data:{user:null,session:null},error:new De}:(T.session&&(await this._saveSession(T.session),await this._notifyAllSubscribers("SIGNED_IN",T.session)),{data:Object.assign({},T),error:$})}catch(T){if(O(T))return{data:{user:null,session:null},error:T};throw T}}async _exchangeCodeForSession(e){const t=await ie(this.storage,`${this.storageKey}-code-verifier`),[r,s]=(t??"").split("/");try{const{data:i,error:o}=await R(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:r},xform:G});if(await Z(this.storage,`${this.storageKey}-code-verifier`),o)throw o;return!i||!i.session||!i.user?{data:{user:null,session:null,redirectType:null},error:new De}:(i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",i.session)),{data:Object.assign(Object.assign({},i),{redirectType:s??null}),error:o})}catch(i){if(O(i))return{data:{user:null,session:null,redirectType:null},error:i};throw i}}async signInWithIdToken(e){try{const{options:t,provider:r,token:s,access_token:i,nonce:o}=e,l=await R(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:r,id_token:s,access_token:i,nonce:o,gotrue_meta_security:{captcha_token:t?.captchaToken}},xform:G}),{data:a,error:c}=l;return c?{data:{user:null,session:null},error:c}:!a||!a.session||!a.user?{data:{user:null,session:null},error:new De}:(a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",a.session)),{data:a,error:c})}catch(t){if(O(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOtp(e){var t,r,s,i,o;try{if("email"in e){const{email:l,options:a}=e;let c=null,u=null;this.flowType==="pkce"&&([c,u]=await ge(this.storage,this.storageKey));const{error:h}=await R(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:l,data:(t=a?.data)!==null&&t!==void 0?t:{},create_user:(r=a?.shouldCreateUser)!==null&&r!==void 0?r:!0,gotrue_meta_security:{captcha_token:a?.captchaToken},code_challenge:c,code_challenge_method:u},redirectTo:a?.emailRedirectTo});return{data:{user:null,session:null},error:h}}if("phone"in e){const{phone:l,options:a}=e,{data:c,error:u}=await R(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:l,data:(s=a?.data)!==null&&s!==void 0?s:{},create_user:(i=a?.shouldCreateUser)!==null&&i!==void 0?i:!0,gotrue_meta_security:{captcha_token:a?.captchaToken},channel:(o=a?.channel)!==null&&o!==void 0?o:"sms"}});return{data:{user:null,session:null,messageId:c?.message_id},error:u}}throw new Le("You must provide either an email or phone number.")}catch(l){if(O(l))return{data:{user:null,session:null},error:l};throw l}}async verifyOtp(e){var t,r;try{let s,i;"options"in e&&(s=(t=e.options)===null||t===void 0?void 0:t.redirectTo,i=(r=e.options)===null||r===void 0?void 0:r.captchaToken);const{data:o,error:l}=await R(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:i}}),redirectTo:s,xform:G});if(l)throw l;if(!o)throw new Error("An error occurred on token verification.");const a=o.session,c=o.user;return a?.access_token&&(await this._saveSession(a),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",a)),{data:{user:c,session:a},error:null}}catch(s){if(O(s))return{data:{user:null,session:null},error:s};throw s}}async signInWithSSO(e){var t,r,s;try{let i=null,o=null;return this.flowType==="pkce"&&([i,o]=await ge(this.storage,this.storageKey)),await R(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(r=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&r!==void 0?r:void 0}),!((s=e?.options)===null||s===void 0)&&s.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:i,code_challenge_method:o}),headers:this.headers,xform:ai})}catch(i){if(O(i))return{data:null,error:i};throw i}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:r}=e;if(r)throw r;if(!t)throw new ee;const{error:s}=await R(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return{data:{user:null,session:null},error:s}})}catch(e){if(O(e))return{data:{user:null,session:null},error:e};throw e}}async resend(e){try{const t=`${this.url}/resend`;if("email"in e){const{email:r,type:s,options:i}=e,{error:o}=await R(this.fetch,"POST",t,{headers:this.headers,body:{email:r,type:s,gotrue_meta_security:{captcha_token:i?.captchaToken}},redirectTo:i?.emailRedirectTo});return{data:{user:null,session:null},error:o}}else if("phone"in e){const{phone:r,type:s,options:i}=e,{data:o,error:l}=await R(this.fetch,"POST",t,{headers:this.headers,body:{phone:r,type:s,gotrue_meta_security:{captcha_token:i?.captchaToken}}});return{data:{user:null,session:null,messageId:o?.message_id},error:l}}throw new Le("You must provide either an email or phone number and a type")}catch(t){if(O(t))return{data:{user:null,session:null},error:t};throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(-1,async()=>this._useSession(async t=>t))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const r=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),s=(async()=>(await r,await t()))();return this.pendingInLock.push((async()=>{try{await s}catch{}})()),s}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const r=t();for(this.pendingInLock.push((async()=>{try{await r}catch{}})()),await r;this.pendingInLock.length;){const s=[...this.pendingInLock];await Promise.all(s),this.pendingInLock.splice(0,s.length)}return await r}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await ie(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const r=e.expires_at?e.expires_at*1e3-Date.now()<Ve:!1;if(this._debug("#__loadSession()",`session has${r?"":" not"} expired`,"expires_at",e.expires_at),!r){if(this.userStorage){const o=await ie(this.userStorage,this.storageKey+"-user");o?.user?e.user=o.user:e.user=Qe()}if(this.storage.isServer&&e.user){let o=this.suppressGetSessionWarning;e=new Proxy(e,{get:(a,c,u)=>(!o&&c==="user"&&(o=!0,this.suppressGetSessionWarning=!0),Reflect.get(a,c,u))})}return{data:{session:e},error:null}}const{session:s,error:i}=await this._callRefreshToken(e.refresh_token);return i?{data:{session:null},error:i}:{data:{session:s},error:null}}finally{this._debug("#__loadSession()","end")}}async getUser(e){return e?await this._getUser(e):(await this.initializePromise,await this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(e){try{return e?await R(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:te}):await this._useSession(async t=>{var r,s,i;const{data:o,error:l}=t;if(l)throw l;return!(!((r=o.session)===null||r===void 0)&&r.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new ee}:await R(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(i=(s=o.session)===null||s===void 0?void 0:s.access_token)!==null&&i!==void 0?i:void 0,xform:te})})}catch(t){if(O(t))return $s(t)&&(await this._removeSession(),await Z(this.storage,`${this.storageKey}-code-verifier`)),{data:{user:null},error:t};throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async r=>{const{data:s,error:i}=r;if(i)throw i;if(!s.session)throw new ee;const o=s.session;let l=null,a=null;this.flowType==="pkce"&&e.email!=null&&([l,a]=await ge(this.storage,this.storageKey));const{data:c,error:u}=await R(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t?.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:l,code_challenge_method:a}),jwt:o.access_token,xform:te});if(u)throw u;return o.user=c.user,await this._saveSession(o),await this._notifyAllSubscribers("USER_UPDATED",o),{data:{user:o.user},error:null}})}catch(r){if(O(r))return{data:{user:null},error:r};throw r}}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new ee;const t=Date.now()/1e3;let r=t,s=!0,i=null;const{payload:o}=Xe(e.access_token);if(o.exp&&(r=o.exp,s=r<=t),s){const{session:l,error:a}=await this._callRefreshToken(e.refresh_token);if(a)return{data:{user:null,session:null},error:a};if(!l)return{data:{user:null,session:null},error:null};i=l}else{const{data:l,error:a}=await this._getUser(e.access_token);if(a)throw a;i={access_token:e.access_token,refresh_token:e.refresh_token,user:l.user,token_type:"bearer",expires_in:r-t,expires_at:r},await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)}return{data:{user:i.user,session:i},error:null}}catch(t){if(O(t))return{data:{session:null,user:null},error:t};throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var r;if(!e){const{data:o,error:l}=t;if(l)throw l;e=(r=o.session)!==null&&r!==void 0?r:void 0}if(!e?.refresh_token)throw new ee;const{session:s,error:i}=await this._callRefreshToken(e.refresh_token);return i?{data:{user:null,session:null},error:i}:s?{data:{user:s.user,session:s},error:null}:{data:{user:null,session:null},error:null}})}catch(t){if(O(t))return{data:{user:null,session:null},error:t};throw t}}async _getSessionFromURL(e,t){try{if(!H())throw new Ne("No browser detected.");if(e.error||e.error_description||e.error_code)throw new Ne(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if(this.flowType==="pkce")throw new $t("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new Ne("Not a valid implicit grant flow url.");break;default:}if(t==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new $t("No code detected.");const{data:F,error:S}=await this._exchangeCodeForSession(e.code);if(S)throw S;const C=new URL(window.location.href);return C.searchParams.delete("code"),window.history.replaceState(window.history.state,"",C.toString()),{data:{session:F.session,redirectType:null},error:null}}const{provider_token:r,provider_refresh_token:s,access_token:i,refresh_token:o,expires_in:l,expires_at:a,token_type:c}=e;if(!i||!l||!o||!c)throw new Ne("No session defined in URL");const u=Math.round(Date.now()/1e3),h=parseInt(l);let p=u+h;a&&(p=parseInt(a));const g=p-u;g*1e3<=ye&&`${g}${h}`;const k=p-h;u-k>=120||u-k<0;const{data:A,error:T}=await this._getUser(i);if(T)throw T;const $={provider_token:r,provider_refresh_token:s,access_token:i,expires_in:h,expires_at:p,refresh_token:o,token_type:c,user:A.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),{data:{session:$,redirectType:e.type},error:null}}catch(r){if(O(r))return{data:{session:null,redirectType:null},error:r};throw r}}_isImplicitGrantCallback(e){return!!(e.access_token||e.error_description)}async _isPKCECallback(e){const t=await ie(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var r;const{data:s,error:i}=t;if(i)return{error:i};const o=(r=s.session)===null||r===void 0?void 0:r.access_token;if(o){const{error:l}=await this.admin.signOut(o,e);if(l&&!(Rs(l)&&(l.status===404||l.status===401||l.status===403)))return{error:l}}return e!=="others"&&(await this._removeSession(),await Z(this.storage,`${this.storageKey}-code-verifier`)),{error:null}})}onAuthStateChange(e){const t=Ws(),r={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,r),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:r}}}async _emitInitialSession(e){return await this._useSession(async t=>{var r,s;try{const{data:{session:i},error:o}=t;if(o)throw o;await((r=this.stateChangeEmitters.get(e))===null||r===void 0?void 0:r.callback("INITIAL_SESSION",i)),this._debug("INITIAL_SESSION","callback id",e,"session",i)}catch(i){await((s=this.stateChangeEmitters.get(e))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",i),console.error(i)}})}async resetPasswordForEmail(e,t={}){let r=null,s=null;this.flowType==="pkce"&&([r,s]=await ge(this.storage,this.storageKey,!0));try{return await R(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:r,code_challenge_method:s,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(i){if(O(i))return{data:null,error:i};throw i}}async getUserIdentities(){var e;try{const{data:t,error:r}=await this.getUser();if(r)throw r;return{data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null}}catch(t){if(O(t))return{data:null,error:t};throw t}}async linkIdentity(e){var t;try{const{data:r,error:s}=await this._useSession(async i=>{var o,l,a,c,u;const{data:h,error:p}=i;if(p)throw p;const g=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(o=e.options)===null||o===void 0?void 0:o.redirectTo,scopes:(l=e.options)===null||l===void 0?void 0:l.scopes,queryParams:(a=e.options)===null||a===void 0?void 0:a.queryParams,skipBrowserRedirect:!0});return await R(this.fetch,"GET",g,{headers:this.headers,jwt:(u=(c=h.session)===null||c===void 0?void 0:c.access_token)!==null&&u!==void 0?u:void 0})});if(s)throw s;return H()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(r?.url),{data:{provider:e.provider,url:r?.url},error:null}}catch(r){if(O(r))return{data:{provider:e.provider,url:null},error:r};throw r}}async unlinkIdentity(e){try{return await this._useSession(async t=>{var r,s;const{data:i,error:o}=t;if(o)throw o;return await R(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(s=(r=i.session)===null||r===void 0?void 0:r.access_token)!==null&&s!==void 0?s:void 0})})}catch(t){if(O(t))return{data:null,error:t};throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const r=Date.now();return await Js(async s=>(s>0&&await Ks(200*Math.pow(2,s-1)),this._debug(t,"refreshing attempt",s),await R(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:G})),(s,i)=>{const o=200*Math.pow(2,s);return i&&Ye(i)&&Date.now()+o-r<ye})}catch(r){if(this._debug(t,"error",r),O(r))return{data:{session:null,user:null},error:r};throw r}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const r=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",r),H()&&!t.skipBrowserRedirect&&window.location.assign(r),{data:{provider:e,url:r},error:null}}async _recoverAndRefresh(){var e,t;const r="#_recoverAndRefresh()";this._debug(r,"begin");try{const s=await ie(this.storage,this.storageKey);if(s&&this.userStorage){let o=await ie(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!o&&(o={user:s.user},await me(this.userStorage,this.storageKey+"-user",o)),s.user=(e=o?.user)!==null&&e!==void 0?e:Qe()}else if(s&&!s.user&&!s.user){const o=await ie(this.storage,this.storageKey+"-user");o&&o?.user?(s.user=o.user,await Z(this.storage,this.storageKey+"-user"),await me(this.storage,this.storageKey,s)):s.user=Qe()}if(this._debug(r,"session from storage",s),!this._isValidSession(s)){this._debug(r,"session is not valid"),s!==null&&await this._removeSession();return}const i=((t=s.expires_at)!==null&&t!==void 0?t:1/0)*1e3-Date.now()<Ve;if(this._debug(r,`session has${i?"":" not"} expired with margin of ${Ve}s`),i){if(this.autoRefreshToken&&s.refresh_token){const{error:o}=await this._callRefreshToken(s.refresh_token);o&&(console.error(o),Ye(o)||(this._debug(r,"refresh failed with a non-retryable error, removing the session",o),await this._removeSession()))}}else if(s.user&&s.user.__isUserNotAvailableProxy===!0)try{const{data:o,error:l}=await this._getUser(s.access_token);!l&&o?.user?(s.user=o.user,await this._saveSession(s),await this._notifyAllSubscribers("SIGNED_IN",s)):this._debug(r,"could not get user data, skipping SIGNED_IN notification")}catch(o){console.error("Error getting user data:",o),this._debug(r,"error getting user data, skipping SIGNED_IN notification",o)}else await this._notifyAllSubscribers("SIGNED_IN",s)}catch(s){this._debug(r,"error",s),console.error(s);return}finally{this._debug(r,"end")}}async _callRefreshToken(e){var t,r;if(!e)throw new ee;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const s=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(s,"begin");try{this.refreshingDeferred=new qe;const{data:i,error:o}=await this._refreshAccessToken(e);if(o)throw o;if(!i.session)throw new ee;await this._saveSession(i.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",i.session);const l={session:i.session,error:null};return this.refreshingDeferred.resolve(l),l}catch(i){if(this._debug(s,"error",i),O(i)){const o={session:null,error:i};return Ye(i)||await this._removeSession(),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(o),o}throw(r=this.refreshingDeferred)===null||r===void 0||r.reject(i),i}finally{this.refreshingDeferred=null,this._debug(s,"end")}}async _notifyAllSubscribers(e,t,r=!0){const s=`#_notifyAllSubscribers(${e})`;this._debug(s,"begin",t,`broadcast = ${r}`);try{this.broadcastChannel&&r&&this.broadcastChannel.postMessage({event:e,session:t});const i=[],o=Array.from(this.stateChangeEmitters.values()).map(async l=>{try{await l.callback(e,t)}catch(a){i.push(a)}});if(await Promise.all(o),i.length>0){for(let l=0;l<i.length;l+=1)console.error(i[l]);throw i[0]}}finally{this._debug(s,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0;const t=Object.assign({},e),r=t.user&&t.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!r&&t.user&&await me(this.userStorage,this.storageKey+"-user",{user:t.user});const s=Object.assign({},t);delete s.user;const i=Lt(s);await me(this.storage,this.storageKey,i)}else{const s=Lt(t);await me(this.storage,this.storageKey,s)}}async _removeSession(){this._debug("#_removeSession()"),await Z(this.storage,this.storageKey),await Z(this.storage,this.storageKey+"-code-verifier"),await Z(this.storage,this.storageKey+"-user"),this.userStorage&&await Z(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&H()&&window?.removeEventListener&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),ye);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:r}}=t;if(!r||!r.refresh_token||!r.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const s=Math.floor((r.expires_at*1e3-e)/ye);this._debug("#_autoRefreshTokenTick()",`access token expires in ${s} ticks, a tick lasts ${ye}ms, refresh threshold is ${lt} ticks`),s<=lt&&await this._callRefreshToken(r.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof hr)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!H()||!window?.addEventListener)return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window?.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,r){const s=[`provider=${encodeURIComponent(t)}`];if(r?.redirectTo&&s.push(`redirect_to=${encodeURIComponent(r.redirectTo)}`),r?.scopes&&s.push(`scopes=${encodeURIComponent(r.scopes)}`),this.flowType==="pkce"){const[i,o]=await ge(this.storage,this.storageKey),l=new URLSearchParams({code_challenge:`${encodeURIComponent(i)}`,code_challenge_method:`${encodeURIComponent(o)}`});s.push(l.toString())}if(r?.queryParams){const i=new URLSearchParams(r.queryParams);s.push(i.toString())}return r?.skipBrowserRedirect&&s.push(`skip_http_redirect=${r.skipBrowserRedirect}`),`${e}?${s.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var r;const{data:s,error:i}=t;return i?{data:null,error:i}:await R(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(r=s?.session)===null||r===void 0?void 0:r.access_token})})}catch(t){if(O(t))return{data:null,error:t};throw t}}async _enroll(e){try{return await this._useSession(async t=>{var r,s;const{data:i,error:o}=t;if(o)return{data:null,error:o};const l=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:{issuer:e.issuer}),{data:a,error:c}=await R(this.fetch,"POST",`${this.url}/factors`,{body:l,headers:this.headers,jwt:(r=i?.session)===null||r===void 0?void 0:r.access_token});return c?{data:null,error:c}:(e.factorType==="totp"&&(!((s=a?.totp)===null||s===void 0)&&s.qr_code)&&(a.totp.qr_code=`data:image/svg+xml;utf-8,${a.totp.qr_code}`),{data:a,error:null})})}catch(t){if(O(t))return{data:null,error:t};throw t}}async _verify(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var r;const{data:s,error:i}=t;if(i)return{data:null,error:i};const{data:o,error:l}=await R(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:{code:e.code,challenge_id:e.challengeId},headers:this.headers,jwt:(r=s?.session)===null||r===void 0?void 0:r.access_token});return l?{data:null,error:l}:(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+o.expires_in},o)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",o),{data:o,error:l})})}catch(t){if(O(t))return{data:null,error:t};throw t}})}async _challenge(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var r;const{data:s,error:i}=t;return i?{data:null,error:i}:await R(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:{channel:e.channel},headers:this.headers,jwt:(r=s?.session)===null||r===void 0?void 0:r.access_token})})}catch(t){if(O(t))return{data:null,error:t};throw t}})}async _challengeAndVerify(e){const{data:t,error:r}=await this._challenge({factorId:e.factorId});return r?{data:null,error:r}:await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){const{data:{user:e},error:t}=await this.getUser();if(t)return{data:null,error:t};const r=e?.factors||[],s=r.filter(o=>o.factor_type==="totp"&&o.status==="verified"),i=r.filter(o=>o.factor_type==="phone"&&o.status==="verified");return{data:{all:r,totp:s,phone:i},error:null}}async _getAuthenticatorAssuranceLevel(){return this._acquireLock(-1,async()=>await this._useSession(async e=>{var t,r;const{data:{session:s},error:i}=e;if(i)return{data:null,error:i};if(!s)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:o}=Xe(s.access_token);let l=null;o.aal&&(l=o.aal);let a=l;((r=(t=s.user.factors)===null||t===void 0?void 0:t.filter(h=>h.status==="verified"))!==null&&r!==void 0?r:[]).length>0&&(a="aal2");const u=o.amr||[];return{data:{currentLevel:l,nextLevel:a,currentAuthenticationMethods:u},error:null}}))}async fetchJwk(e,t={keys:[]}){let r=t.keys.find(l=>l.kid===e);if(r)return r;const s=Date.now();if(r=this.jwks.keys.find(l=>l.kid===e),r&&this.jwks_cached_at+Ps>s)return r;const{data:i,error:o}=await R(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(o)throw o;return!i.keys||i.keys.length===0||(this.jwks=i,this.jwks_cached_at=s,r=i.keys.find(l=>l.kid===e),!r)?null:r}async getClaims(e,t={}){try{let r=e;if(!r){const{data:g,error:k}=await this.getSession();if(k||!g.session)return{data:null,error:k};r=g.session.access_token}const{header:s,payload:i,signature:o,raw:{header:l,payload:a}}=Xe(r);t?.allowExpired||ei(i.exp);const c=!s.alg||s.alg.startsWith("HS")||!s.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(s.kid,t?.keys?{keys:t.keys}:t?.jwks);if(!c){const{error:g}=await this.getUser(r);if(g)throw g;return{data:{claims:i,header:s,signature:o},error:null}}const u=ti(s.alg),h=await crypto.subtle.importKey("jwk",c,u,!0,["verify"]);if(!await crypto.subtle.verify(u,h,o,Bs(`${l}.${a}`)))throw new ht("Invalid JWT signature");return{data:{claims:i,header:s,signature:o},error:null}}catch(r){if(O(r))return{data:null,error:r};throw r}}}je.nextInstanceID=0;const vi=je;class wi extends vi{constructor(e){super(e)}}var yi=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function l(u){try{c(r.next(u))}catch(h){o(h)}}function a(u){try{c(r.throw(u))}catch(h){o(h)}}function c(u){u.done?i(u.value):s(u.value).then(l,a)}c((r=r.apply(n,e||[])).next())})};class mi{constructor(e,t,r){var s,i,o;this.supabaseUrl=e,this.supabaseKey=t;const l=xs(e);if(!t)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",l),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",l),this.storageUrl=new URL("storage/v1",l),this.functionsUrl=new URL("functions/v1",l);const a=`sb-${l.hostname.split(".")[0]}-auth-token`,c={db:ps,realtime:vs,auth:Object.assign(Object.assign({},_s),{storageKey:a}),global:gs},u=Es(r??{},c);this.storageKey=(s=u.auth.storageKey)!==null&&s!==void 0?s:"",this.headers=(i=u.global.headers)!==null&&i!==void 0?i:{},u.accessToken?(this.accessToken=u.accessToken,this.auth=new Proxy({},{get:(h,p)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(p)} is not possible`)}})):this.auth=this._initSupabaseAuthClient((o=u.auth)!==null&&o!==void 0?o:{},this.headers,u.global.fetch),this.fetch=bs(t,this._getAccessToken.bind(this),u.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},u.realtime)),this.rest=new Fr(new URL("rest/v1",l).href,{headers:this.headers,schema:u.db.schema,fetch:this.fetch}),this.storage=new hs(this.storageUrl.href,this.headers,this.fetch,r?.storage),u.accessToken||this._listenForAuthEvents()}get functions(){return new xr(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,t={},r={}){return this.rest.rpc(e,t,r)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}_getAccessToken(){var e,t;return yi(this,void 0,void 0,function*(){if(this.accessToken)return yield this.accessToken();const{data:r}=yield this.auth.getSession();return(t=(e=r.session)===null||e===void 0?void 0:e.access_token)!==null&&t!==void 0?t:this.supabaseKey})}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:r,storage:s,userStorage:i,storageKey:o,flowType:l,lock:a,debug:c},u,h){const p={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new wi({url:this.authUrl.href,headers:Object.assign(Object.assign({},p),u),storageKey:o,autoRefreshToken:e,persistSession:t,detectSessionInUrl:r,storage:s,userStorage:i,flowType:l,lock:a,debug:c,fetch:h,hasCustomAuthorizationHeader:Object.keys(this.headers).some(g=>g.toLowerCase()==="authorization")})}_initRealtimeClient(e){return new Qr(this.realtimeUrl.href,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},e?.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,r)=>{this._handleTokenChanged(t,"CLIENT",r?.access_token)})}_handleTokenChanged(e,t,r){(e==="TOKEN_REFRESHED"||e==="SIGNED_IN")&&this.changedAccessToken!==r?this.changedAccessToken=r:e==="SIGNED_OUT"&&(this.realtime.setAuth(),t=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}const bi=(n,e,t)=>new mi(n,e,t);function ki(){if(typeof window<"u"||typeof process>"u")return!1;const n=process.version;if(n==null)return!1;const e=n.match(/^v(\d+)\./);return e?parseInt(e[1],10)<=18:!1}ki();const Si="https://fsmgroeytsburlgmoxcj.supabase.co",Ei="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZzbWdyb2V5dHNidXJsZ21veGNqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MzUwMjQsImV4cCI6MjA3MzUxMTAyNH0.z6T4B5HtUuLoQD-hmSNJEWCmoXCM0_pNoy5MlaC49ok",N=bi(Si,Ei,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,storage:typeof window<"u"?window.localStorage:void 0,storageKey:"supabase.auth.token",flowType:"pkce",debug:!1},realtime:{params:{eventsPerSecond:10}},global:{headers:{"X-Client-Info":"describe-music-web"}}}),Fi=Object.freeze(Object.defineProperty({__proto__:null,supabase:N},Symbol.toStringTag,{value:"Module"}));var et={exports:{}};const xi={},Ti=Object.freeze(Object.defineProperty({__proto__:null,default:xi},Symbol.toStringTag,{value:"Module"})),Wt=Kt(Ti);/**
 * [js-sha256]{@link https://github.com/emn178/js-sha256}
 *
 * @version 0.10.1
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2023
 * @license MIT
 */var zt;function Ai(){return zt||(zt=1,(function(n){(function(){var e="input is invalid type",t=typeof window=="object",r=t?window:{};r.JS_SHA256_NO_WINDOW&&(t=!1);var s=!t&&typeof self=="object",i=!r.JS_SHA256_NO_NODE_JS&&typeof process=="object"&&process.versions&&process.versions.node;i?r=_r:s&&(r=self);var o=!r.JS_SHA256_NO_COMMON_JS&&!0&&n.exports,l=!r.JS_SHA256_NO_ARRAY_BUFFER&&typeof ArrayBuffer<"u",a="0123456789abcdef".split(""),c=[-2147483648,8388608,32768,128],u=[24,16,8,0],h=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],p=["hex","array","digest","arrayBuffer"],g=[];(r.JS_SHA256_NO_NODE_JS||!Array.isArray)&&(Array.isArray=function(d){return Object.prototype.toString.call(d)==="[object Array]"}),l&&(r.JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW||!ArrayBuffer.isView)&&(ArrayBuffer.isView=function(d){return typeof d=="object"&&d.buffer&&d.buffer.constructor===ArrayBuffer});var k=function(d,y){return function(v){return new S(y,!0).update(v)[d]()}},A=function(d){var y=k("hex",d);i&&(y=T(y,d)),y.create=function(){return new S(d)},y.update=function(b){return y.create().update(b)};for(var v=0;v<p.length;++v){var w=p[v];y[w]=k(w,d)}return y},T=function(d,y){var v=Wt,w=Wt.Buffer,b=y?"sha224":"sha256",m;w.from&&!r.JS_SHA256_NO_BUFFER_FROM?m=w.from:m=function(f){return new w(f)};var _=function(f){if(typeof f=="string")return v.createHash(b).update(f,"utf8").digest("hex");if(f==null)throw new Error(e);return f.constructor===ArrayBuffer&&(f=new Uint8Array(f)),Array.isArray(f)||ArrayBuffer.isView(f)||f.constructor===w?v.createHash(b).update(m(f)).digest("hex"):d(f)};return _},$=function(d,y){return function(v,w){return new C(v,y,!0).update(w)[d]()}},F=function(d){var y=$("hex",d);y.create=function(b){return new C(b,d)},y.update=function(b,m){return y.create(b).update(m)};for(var v=0;v<p.length;++v){var w=p[v];y[w]=$(w,d)}return y};function S(d,y){y?(g[0]=g[16]=g[1]=g[2]=g[3]=g[4]=g[5]=g[6]=g[7]=g[8]=g[9]=g[10]=g[11]=g[12]=g[13]=g[14]=g[15]=0,this.blocks=g):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],d?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=d}S.prototype.update=function(d){if(!this.finalized){var y,v=typeof d;if(v!=="string"){if(v==="object"){if(d===null)throw new Error(e);if(l&&d.constructor===ArrayBuffer)d=new Uint8Array(d);else if(!Array.isArray(d)&&(!l||!ArrayBuffer.isView(d)))throw new Error(e)}else throw new Error(e);y=!0}for(var w,b=0,m,_=d.length,f=this.blocks;b<_;){if(this.hashed&&(this.hashed=!1,f[0]=this.block,f[16]=f[1]=f[2]=f[3]=f[4]=f[5]=f[6]=f[7]=f[8]=f[9]=f[10]=f[11]=f[12]=f[13]=f[14]=f[15]=0),y)for(m=this.start;b<_&&m<64;++b)f[m>>2]|=d[b]<<u[m++&3];else for(m=this.start;b<_&&m<64;++b)w=d.charCodeAt(b),w<128?f[m>>2]|=w<<u[m++&3]:w<2048?(f[m>>2]|=(192|w>>6)<<u[m++&3],f[m>>2]|=(128|w&63)<<u[m++&3]):w<55296||w>=57344?(f[m>>2]|=(224|w>>12)<<u[m++&3],f[m>>2]|=(128|w>>6&63)<<u[m++&3],f[m>>2]|=(128|w&63)<<u[m++&3]):(w=65536+((w&1023)<<10|d.charCodeAt(++b)&1023),f[m>>2]|=(240|w>>18)<<u[m++&3],f[m>>2]|=(128|w>>12&63)<<u[m++&3],f[m>>2]|=(128|w>>6&63)<<u[m++&3],f[m>>2]|=(128|w&63)<<u[m++&3]);this.lastByteIndex=m,this.bytes+=m-this.start,m>=64?(this.block=f[16],this.start=m-64,this.hash(),this.hashed=!0):this.start=m}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}},S.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var d=this.blocks,y=this.lastByteIndex;d[16]=this.block,d[y>>2]|=c[y&3],this.block=d[16],y>=56&&(this.hashed||this.hash(),d[0]=this.block,d[16]=d[1]=d[2]=d[3]=d[4]=d[5]=d[6]=d[7]=d[8]=d[9]=d[10]=d[11]=d[12]=d[13]=d[14]=d[15]=0),d[14]=this.hBytes<<3|this.bytes>>>29,d[15]=this.bytes<<3,this.hash()}},S.prototype.hash=function(){var d=this.h0,y=this.h1,v=this.h2,w=this.h3,b=this.h4,m=this.h5,_=this.h6,f=this.h7,E=this.blocks,x,j,L,z,U,X,Q,Se,We,ze,Ie;for(x=16;x<64;++x)U=E[x-15],j=(U>>>7|U<<25)^(U>>>18|U<<14)^U>>>3,U=E[x-2],L=(U>>>17|U<<15)^(U>>>19|U<<13)^U>>>10,E[x]=E[x-16]+j+E[x-7]+L<<0;for(Ie=y&v,x=0;x<64;x+=4)this.first?(this.is224?(Se=300032,U=E[0]-1413257819,f=U-150054599<<0,w=U+24177077<<0):(Se=704751109,U=E[0]-210244248,f=U-1521486534<<0,w=U+143694565<<0),this.first=!1):(j=(d>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10),L=(b>>>6|b<<26)^(b>>>11|b<<21)^(b>>>25|b<<7),Se=d&y,z=Se^d&v^Ie,Q=b&m^~b&_,U=f+L+Q+h[x]+E[x],X=j+z,f=w+U<<0,w=U+X<<0),j=(w>>>2|w<<30)^(w>>>13|w<<19)^(w>>>22|w<<10),L=(f>>>6|f<<26)^(f>>>11|f<<21)^(f>>>25|f<<7),We=w&d,z=We^w&y^Se,Q=f&b^~f&m,U=_+L+Q+h[x+1]+E[x+1],X=j+z,_=v+U<<0,v=U+X<<0,j=(v>>>2|v<<30)^(v>>>13|v<<19)^(v>>>22|v<<10),L=(_>>>6|_<<26)^(_>>>11|_<<21)^(_>>>25|_<<7),ze=v&w,z=ze^v&d^We,Q=_&f^~_&b,U=m+L+Q+h[x+2]+E[x+2],X=j+z,m=y+U<<0,y=U+X<<0,j=(y>>>2|y<<30)^(y>>>13|y<<19)^(y>>>22|y<<10),L=(m>>>6|m<<26)^(m>>>11|m<<21)^(m>>>25|m<<7),Ie=y&v,z=Ie^y&w^ze,Q=m&_^~m&f,U=b+L+Q+h[x+3]+E[x+3],X=j+z,b=d+U<<0,d=U+X<<0,this.chromeBugWorkAround=!0;this.h0=this.h0+d<<0,this.h1=this.h1+y<<0,this.h2=this.h2+v<<0,this.h3=this.h3+w<<0,this.h4=this.h4+b<<0,this.h5=this.h5+m<<0,this.h6=this.h6+_<<0,this.h7=this.h7+f<<0},S.prototype.hex=function(){this.finalize();var d=this.h0,y=this.h1,v=this.h2,w=this.h3,b=this.h4,m=this.h5,_=this.h6,f=this.h7,E=a[d>>28&15]+a[d>>24&15]+a[d>>20&15]+a[d>>16&15]+a[d>>12&15]+a[d>>8&15]+a[d>>4&15]+a[d&15]+a[y>>28&15]+a[y>>24&15]+a[y>>20&15]+a[y>>16&15]+a[y>>12&15]+a[y>>8&15]+a[y>>4&15]+a[y&15]+a[v>>28&15]+a[v>>24&15]+a[v>>20&15]+a[v>>16&15]+a[v>>12&15]+a[v>>8&15]+a[v>>4&15]+a[v&15]+a[w>>28&15]+a[w>>24&15]+a[w>>20&15]+a[w>>16&15]+a[w>>12&15]+a[w>>8&15]+a[w>>4&15]+a[w&15]+a[b>>28&15]+a[b>>24&15]+a[b>>20&15]+a[b>>16&15]+a[b>>12&15]+a[b>>8&15]+a[b>>4&15]+a[b&15]+a[m>>28&15]+a[m>>24&15]+a[m>>20&15]+a[m>>16&15]+a[m>>12&15]+a[m>>8&15]+a[m>>4&15]+a[m&15]+a[_>>28&15]+a[_>>24&15]+a[_>>20&15]+a[_>>16&15]+a[_>>12&15]+a[_>>8&15]+a[_>>4&15]+a[_&15];return this.is224||(E+=a[f>>28&15]+a[f>>24&15]+a[f>>20&15]+a[f>>16&15]+a[f>>12&15]+a[f>>8&15]+a[f>>4&15]+a[f&15]),E},S.prototype.toString=S.prototype.hex,S.prototype.digest=function(){this.finalize();var d=this.h0,y=this.h1,v=this.h2,w=this.h3,b=this.h4,m=this.h5,_=this.h6,f=this.h7,E=[d>>24&255,d>>16&255,d>>8&255,d&255,y>>24&255,y>>16&255,y>>8&255,y&255,v>>24&255,v>>16&255,v>>8&255,v&255,w>>24&255,w>>16&255,w>>8&255,w&255,b>>24&255,b>>16&255,b>>8&255,b&255,m>>24&255,m>>16&255,m>>8&255,m&255,_>>24&255,_>>16&255,_>>8&255,_&255];return this.is224||E.push(f>>24&255,f>>16&255,f>>8&255,f&255),E},S.prototype.array=S.prototype.digest,S.prototype.arrayBuffer=function(){this.finalize();var d=new ArrayBuffer(this.is224?28:32),y=new DataView(d);return y.setUint32(0,this.h0),y.setUint32(4,this.h1),y.setUint32(8,this.h2),y.setUint32(12,this.h3),y.setUint32(16,this.h4),y.setUint32(20,this.h5),y.setUint32(24,this.h6),this.is224||y.setUint32(28,this.h7),d};function C(d,y,v){var w,b=typeof d;if(b==="string"){var m=[],_=d.length,f=0,E;for(w=0;w<_;++w)E=d.charCodeAt(w),E<128?m[f++]=E:E<2048?(m[f++]=192|E>>6,m[f++]=128|E&63):E<55296||E>=57344?(m[f++]=224|E>>12,m[f++]=128|E>>6&63,m[f++]=128|E&63):(E=65536+((E&1023)<<10|d.charCodeAt(++w)&1023),m[f++]=240|E>>18,m[f++]=128|E>>12&63,m[f++]=128|E>>6&63,m[f++]=128|E&63);d=m}else if(b==="object"){if(d===null)throw new Error(e);if(l&&d.constructor===ArrayBuffer)d=new Uint8Array(d);else if(!Array.isArray(d)&&(!l||!ArrayBuffer.isView(d)))throw new Error(e)}else throw new Error(e);d.length>64&&(d=new S(y,!0).update(d).array());var x=[],j=[];for(w=0;w<64;++w){var L=d[w]||0;x[w]=92^L,j[w]=54^L}S.call(this,y,v),this.update(j),this.oKeyPad=x,this.inner=!0,this.sharedMemory=v}C.prototype=new S,C.prototype.finalize=function(){if(S.prototype.finalize.call(this),this.inner){this.inner=!1;var d=this.array();S.call(this,this.is224,this.sharedMemory),this.update(this.oKeyPad),this.update(d),S.prototype.finalize.call(this)}};var I=A();I.sha256=I,I.sha224=A(!0),I.sha256.hmac=F(),I.sha224.hmac=F(!0),o?n.exports=I:(r.sha256=I.sha256,r.sha224=I.sha224)})()})(et)),et.exports}var xe=Ai();let Te=null,we=null;class Y{static CACHE_KEY="device_fingerprint_cache";static CACHE_EXPIRY_KEY="device_fingerprint_expiry";static CACHE_DURATION=1440*60*1e3;static async generate(){if(Te)return Te;if(we)return we;const e=this.getCachedFingerprint();if(e)return Te=e,e;we=this.generateFingerprint();try{const t=await we;return Te=t,this.setCachedFingerprint(t),t}finally{we=null}}static async generateFingerprint(){const e={screen:this.getScreenFingerprint(),timezone:this.getTimezoneFingerprint(),language:this.getLanguageFingerprint(),platform:this.getPlatformFingerprint(),canvas:await this.getCanvasFingerprint(),webgl:this.getWebGLFingerprint(),audio:await this.getAudioFingerprint(),userAgent:this.getUserAgentFingerprint()},s=`${Object.values(e).join("|")}|describe-music-salt-2025-x9k2m8n4p7q1`;return xe.sha256(s)}static getScreenFingerprint(){if(typeof window>"u")return"server";const e=window.screen;return[e.width,e.height,e.colorDepth,e.pixelDepth,window.devicePixelRatio||1].join("x")}static getTimezoneFingerprint(){try{const e=Intl.DateTimeFormat().resolvedOptions().timeZone,t=new Date().getTimezoneOffset();return`${e}:${t}`}catch{return"unknown"}}static getLanguageFingerprint(){return typeof navigator>"u"?"server":[navigator.language,navigator.languages?.slice(0,3).join(",")||""].join("|")}static getPlatformFingerprint(){return typeof navigator>"u"?"server":[navigator.platform,navigator.hardwareConcurrency||0,navigator.maxTouchPoints||0].join("|")}static async getCanvasFingerprint(){if(typeof window>"u")return"server";try{const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)return"no-canvas";e.width=200,e.height=50,t.textBaseline="top",t.font="14px Arial",t.fillStyle="#f60",t.fillRect(125,1,62,20),t.fillStyle="#069",t.fillText("Device Fingerprint 🎵",2,15),t.fillStyle="rgba(102, 204, 0, 0.7)",t.fillText("Audio Analysis",4,35),t.globalCompositeOperation="multiply",t.fillStyle="rgb(255,0,255)",t.beginPath(),t.arc(50,25,20,0,Math.PI*2,!0),t.closePath(),t.fill();const r=e.toDataURL();return xe.sha256(r).substring(0,16)}catch{return"canvas-error"}}static getWebGLFingerprint(){if(typeof window>"u")return"server";try{const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return"no-webgl";const r=t.getExtension("WEBGL_debug_renderer_info"),s=r?t.getParameter(r.UNMASKED_VENDOR_WEBGL):"",i=r?t.getParameter(r.UNMASKED_RENDERER_WEBGL):"";return xe.sha256(`${s}|${i}`).substring(0,16)}catch{return"webgl-error"}}static async getAudioFingerprint(){if(typeof window>"u")return"server";try{const e=window.AudioContext||window.webkitAudioContext;if(!e)return"no-audio";const t=new e,r=t.createOscillator(),s=t.createAnalyser(),i=t.createGain(),o=t.createScriptProcessor(4096,1,1);r.type="triangle",r.frequency.setValueAtTime(1e4,t.currentTime),i.gain.setValueAtTime(0,t.currentTime),r.connect(s),s.connect(o),o.connect(i),i.connect(t.destination),r.start(0);const l=new Float32Array(s.frequencyBinCount);s.getFloatFrequencyData(l),r.stop(),t.close();const a=l.reduce((c,u)=>c+Math.abs(u),0);return xe.sha256(a.toString()).substring(0,16)}catch{return"audio-error"}}static getUserAgentFingerprint(){if(typeof navigator>"u")return"server";const t=navigator.userAgent.match(/(Chrome|Firefox|Safari|Edge)\/[\d.]+/g)||[];return xe.sha256(t.join("|")).substring(0,16)}static getCachedFingerprint(){if(typeof localStorage>"u")return null;try{const e=localStorage.getItem(this.CACHE_KEY),t=localStorage.getItem(this.CACHE_EXPIRY_KEY);if(!e||!t)return null;const r=parseInt(t,10);return Date.now()>r?(localStorage.removeItem(this.CACHE_KEY),localStorage.removeItem(this.CACHE_EXPIRY_KEY),null):e}catch{return null}}static setCachedFingerprint(e){if(!(typeof localStorage>"u"))try{const t=Date.now()+this.CACHE_DURATION;localStorage.setItem(this.CACHE_KEY,e),localStorage.setItem(this.CACHE_EXPIRY_KEY,t.toString())}catch{}}static clearCache(){if(Te=null,we=null,typeof localStorage<"u")try{localStorage.removeItem(this.CACHE_KEY),localStorage.removeItem(this.CACHE_EXPIRY_KEY)}catch{}}static async getTrialUsage(e){try{const t=e||await this.generate(),{data:r,error:s}=await N.rpc("check_device_fingerprint_usage",{fingerprint_hash_param:t});if(s)return console.error("Error checking device usage:",s),{canAnalyze:!0,remainingTrials:5,isRegistered:!1};const i=r?.[0];return{canAnalyze:i?.can_analyze??!0,remainingTrials:i?.remaining_trials??5,isRegistered:i?.is_registered??!1}}catch(t){return console.error("Error getting trial usage:",t),{canAnalyze:!0,remainingTrials:5,isRegistered:!1}}}static async updateTrialUsage(e){try{const t=e||await this.generate()}catch(t){console.error("Error updating trial usage:",t)}}static async clearTrialData(e){try{const t=e||await this.generate(),{data:{user:r}}=await N.auth.getUser();if(!r)return;const{data:s,error:i}=await N.rpc("associate_device_fingerprint_to_user",{fingerprint_hash_param:t,user_uuid:r.id});i&&console.error("Error associating device fingerprint to user:",i)}catch(t){console.error("Error clearing trial data:",t)}}static async associateWithUser(e,t){try{const r=t||await this.generate(),{data:s,error:i}=await N.rpc("associate_device_fingerprint_to_user",{fingerprint_hash_param:r,user_uuid:e});return i?(console.error("Error associating device fingerprint:",i),!1):s===!0}catch(r){return console.error("Error in associateWithUser:",r),!1}}static validateFingerprint(e){return/^[a-f0-9]{64}$/i.test(e)}static async getDeviceInfo(){return typeof window>"u"?{environment:"server"}:{screen:this.getScreenFingerprint(),timezone:this.getTimezoneFingerprint(),language:this.getLanguageFingerprint(),platform:this.getPlatformFingerprint(),userAgent:navigator.userAgent.substring(0,100)+"...",timestamp:new Date().toISOString()}}}const Ui=Object.freeze(Object.defineProperty({__proto__:null,DeviceFingerprint:Y},Symbol.toStringTag,{value:"Module"})),dr=P.createContext(void 0);function Di({children:n}){vr.useEffect(()=>()=>{},[]);const[e,t]=P.useState(null),[r,s]=P.useState(null),[i,o]=P.useState(!0),[l,a]=P.useState(null),[c,u]=P.useState(null),h=P.useRef(null),p=P.useRef(!1),g=P.useCallback(async()=>{if(c)return c;try{const v=await Y.generate();return u(v),v}catch(v){console.error("Error generating device fingerprint:",v);const w=`fallback_${Date.now()}_${Math.random()}`;return u(w),w}},[c]),k=P.useCallback(async()=>e?{allowed:!0,remaining:999,total:999,requiresAuth:!1,userType:"registered",message:"已登录用户 - 无限制使用"}:{allowed:!0,remaining:100,total:100,requiresAuth:!1,userType:"trial",message:"Trial Mode - 100 Credits"},[e]),A=P.useCallback(async()=>{},[]),T=P.useCallback(async()=>{try{const v=await k();a(v)}catch(v){console.error("Error refreshing usage status:",v)}},[k]),$=P.useCallback(async(v,w)=>{try{const{data:b,error:m}=await N.auth.signUp({email:v,password:w,options:{data:{registered_at:new Date().toISOString()},emailRedirectTo:typeof window<"u"?`${window.location.origin}/analyze`:void 0}});return m?{data:{user:null,session:null},error:m}:(b.user&&b.user.email,{data:b,error:null})}catch(b){return{data:{user:null,session:null},error:b}}finally{}},[]),F=P.useCallback(async(v,w)=>{try{o(!0);const{data:b,error:m}=await N.auth.signInWithPassword({email:v,password:w});return m?{data:{user:null,session:null},error:m}:(b.session&&b.user&&(s(b.session),t(b.user),a({allowed:!0,remaining:999,total:999,requiresAuth:!1,userType:"registered",message:"Registered user"})),{data:b,error:null})}catch(b){return{data:{user:null,session:null},error:b}}finally{o(!1)}},[]),S=P.useCallback(async()=>{try{o(!0);const{data:v,error:w}=await N.auth.signInWithOAuth({provider:"google",options:{redirectTo:typeof window<"u"?`${window.location.origin}/analyze`:void 0,queryParams:{access_type:"offline",prompt:"consent"}}});return w?{data:{user:null,session:null},error:w}:{data:v,error:null}}catch(v){return{data:{user:null,session:null},error:v}}finally{o(!1)}},[]),C=P.useCallback(async()=>{try{o(!0),s(null),t(null),a({allowed:!0,remaining:100,total:100,requiresAuth:!1,userType:"trial",message:"Trial mode"});try{const{error:v}=await N.auth.signOut();v&&v.message!=="Auth session missing!"&&v.message}catch(v){v.message!=="Auth session missing!"&&v.message}}catch(v){console.error("🔐 Critical error in signOut:",v),s(null),t(null),a({allowed:!0,remaining:100,total:100,requiresAuth:!1,userType:"trial",message:"Trial mode"})}finally{o(!1)}},[]),I=P.useCallback(async v=>{try{const{error:w}=await N.auth.resetPasswordForEmail(v,{redirectTo:`${window.location.origin}/analyze?reset=true`});if(w)throw w}catch(w){throw console.error("Error resetting password:",w),w}},[]),d=P.useCallback(()=>{Y.clearCache(),u(null)},[]);P.useEffect(()=>{if(p.current)return;p.current=!0;let v=!0;return(async()=>{try{const{data:{session:b},error:m}=await N.auth.getSession();if(b?.user?.email,m?.message,b?.expires_at&&new Date(b.expires_at*1e3),b?.expires_at&&b.expires_at*1e3<Date.now(),m?console.error("🔐 Session error:",m):b?.user?.email,v&&(s(b),t(b?.user??null),a({allowed:!0,remaining:b?999:100,total:b?999:100,requiresAuth:!1,userType:b?"registered":"trial",message:b?"Registered user":"Trial mode"}),b?.user?.email,o(!1),b?.user&&(b.user.email,b.expires_at&&b.expires_at*1e3-Date.now()<6e4&&N.auth.refreshSession())),!h.current&&v){const{data:{subscription:_}}=N.auth.onAuthStateChange((f,E)=>{v&&(E?.user?.email,E?.user,E?.user?.email_confirmed_at,f==="SIGNED_IN"||f==="TOKEN_REFRESHED"?E&&E.user&&(s(E),t(E.user),a({allowed:!0,remaining:999,total:999,requiresAuth:!1,userType:"registered",message:"Registered user"})):f==="SIGNED_OUT"&&(s(null),t(null),a({allowed:!0,remaining:100,total:100,requiresAuth:!1,userType:"trial",message:"Trial mode"})))});h.current=_}}catch(b){console.error("🔐 Error initializing auth:",b),v&&o(!1)}})(),()=>{v=!1,h.current&&(h.current.unsubscribe(),h.current=null)}},[]),e?.email;const y={user:e,session:r,loading:i,usageStatus:l,deviceFingerprint:c,signUp:$,signIn:F,signInWithGoogle:S,signOut:C,resetPassword:I,checkUsageLimit:k,consumeUsage:A,refreshUsageStatus:T,getDeviceFingerprint:g,clearDeviceCache:d};return Jt.jsx(dr.Provider,{value:y,children:n})}function fr(){const n=P.useContext(dr);if(n===void 0)throw new Error("useAuth must be used within an AuthProvider");return n}function Li(){const{usageStatus:n,refreshUsageStatus:e}=fr();return{usageStatus:n,canAnalyze:n?.allowed??!1,needsAuth:n?.requiresAuth??!1,refreshUsage:e}}class Ht{static CREDITS_PER_SECOND=1;static MIN_CREDITS_WARNING=100;static calculateCreditsForDuration(e){return e<=0?0:Math.ceil(e)*this.CREDITS_PER_SECOND}static checkBalance(e,t){if(t<=0)return{isValid:!0};if(e>=t){const s=e-t;return s<this.MIN_CREDITS_WARNING?{isValid:!0,suggestion:`After analysis, your credit balance will drop to ${s}. Consider purchasing more credits for continued use.`}:{isValid:!0}}return{isValid:!1,error:`Insufficient credit balance. Need ${t-e} more credits to complete this analysis.`,suggestion:"Please purchase a credit package or wait for next month's credit reset."}}static estimateConsumption(e,t){const r=this.calculateCreditsForDuration(e),s=t>=r,i=s?0:r-t,o=Math.max(0,t-r),l=Math.floor(e/60),a=Math.floor(e%60);let c="";l>0?c=`${l}m ${a}s`:c=`${a}s`;const u=`${c} = ${r} credits`;return{creditsRequired:r,canAfford:s,shortfall:i,estimatedCost:u,balanceAfter:o}}static formatCreditsDisplay(e){if(e<0)return"0";if(e>=1e4){const t=Math.floor(e/1e3),r=e%1e3;return r===0?`${t}k`:`${t}.${Math.floor(r/100)}k`}return`${e.toLocaleString()}`}static formatBalanceDetails(e){const t=[];return e.trial>0&&t.push(`Trial: ${e.trial}`),e.monthly>0&&t.push(`Monthly: ${e.monthly}`),e.purchased>0&&t.push(`Purchased: ${e.purchased}`),t.length===0?"No available credits":t.join(" | ")}static recommendPlan(e){const t=[{id:"basic",name:"Basic Plan",credits:1200,price:9.9},{id:"pro",name:"Professional Plan",credits:3e3,price:19.9},{id:"premium",name:"Premium Plan",credits:7200,price:39.9}],r=t.find(i=>i.credits>=e);if(!r){const i=t[t.length-1];return{...i,planId:i.id,planName:i.name,savings:0}}const s=r.credits-e;return{...r,planId:r.id,planName:r.name,savings:s}}static validateCreditsAmount(e){return Number.isInteger(e)?e<0?{isValid:!1,error:"Credit amount cannot be negative"}:e>1e6?{isValid:!1,error:"Credit amount is too large"}:{isValid:!0}:{isValid:!1,error:"Credit amount must be an integer"}}static calculateMonthlyReset(e,t=200){const r=new Date,s=r.getMonth(),i=r.getFullYear(),o=e.getMonth(),l=e.getFullYear(),a=i>l||i===l&&s>o,c=new Date(i,s+1,1),u=c.getTime()-r.getTime(),h=Math.ceil(u/(1e3*60*60*24));return{shouldReset:a,daysUntilReset:h,nextResetDate:c}}static generateUsageSuggestion(e,t){if(e<=0)return"Your credits have been exhausted. Please purchase a credit package to continue using the service.";if(e<this.MIN_CREDITS_WARNING)return"Your credit balance is low. Consider purchasing more credits to ensure uninterrupted service.";if(t&&t>0){const r=Math.floor(e/t);if(r<7)return`Based on your average usage, current credits will last approximately ${r} days. Consider purchasing more credits in advance.`;if(r<30)return`Based on your average usage, current credits will last approximately ${r} days.`}return"Your credit balance is sufficient for normal service usage."}}const gr=P.createContext(void 0);function Ni({children:n}){const{user:e,loading:t}=fr(),[r,s]=P.useState(0),[i,o]=P.useState(null),[l,a]=P.useState(!0),[c,u]=P.useState(null),[h,p]=P.useState(null),g=P.useCallback(async()=>{if(!e)return 0;try{e.email,u(null);const{data:_,error:f}=await N.rpc("get_user_credit_details",{user_uuid:e.id});if(f){if(console.error("💳 Error checking credits:",f),f.code==="PGRST116"||f.message?.includes("no rows"))return await k(e),200;throw f}const E=_?.[0];if(E){const x=E.total_credits||0,j={total:x,trial:E.trial_credits||0,monthly:E.monthly_credits||0,purchased:E.purchased_credits||0};return s(x),o(j),E.subscription_status&&E.subscription_expires_at?p({id:"current",status:E.subscription_status,planId:"unknown",planName:"Current Plan",credits:0,currentPeriodStart:new Date,currentPeriodEnd:new Date(E.subscription_expires_at),cancelAtPeriodEnd:!1}):p(null),x}else return await k(e),200}catch(_){return console.error("💳 Error in checkCredits:",_),u("Failed to check credits"),0}},[e]),k=P.useCallback(async _=>{try{_.email;const{error:f}=await N.rpc("add_credits",{user_uuid:_.id,credits_amount:200,credit_source:"monthly_grant",description:"Initial monthly credit grant for new user"});if(f)throw console.error("💳 Error creating default credit record:",f),f;s(200),o({total:200,trial:0,monthly:200,purchased:0})}catch(f){throw console.error("💳 Error in createDefaultCreditRecord:",f),f}},[]),A=P.useCallback(async(_,f,E)=>{if(!e)throw new Error("User not authenticated");if(_<=0)throw new Error("Credit amount must be positive");if(r<_)throw new Error(`Insufficient credits. Required: ${_}, Available: ${r}`);try{u(null);const{data:x,error:j}=await N.rpc("consume_credits",{user_uuid:e.id,credits_amount:_,analysis_description:f,analysis_id:E||null});if(j)throw console.error("💳 Error consuming credits:",j),new Error(`Failed to consume credits: ${j.message}`);if(!x)throw new Error("Insufficient credits or consumption failed");await g()}catch(x){throw console.error("💳 Error in consumeCredits:",x),u(x instanceof Error?x.message:"Failed to consume credits"),x}},[e,r,g]),T=P.useCallback(async(_,f,E)=>{if(!e)throw new Error("User not authenticated");if(_<=0)throw new Error("Credit amount must be positive");if(!["purchase","monthly_grant","trial_grant","refund","bonus"].includes(f))throw new Error(`Invalid credit source: ${f}`);try{u(null);const{data:j,error:L}=await N.rpc("add_credits",{user_uuid:e.id,credits_amount:_,credit_source:f,description:E||null});if(L)throw console.error("💳 Error adding credits:",L),new Error(`Failed to add credits: ${L.message}`);if(!j)throw new Error("Failed to add credits - database operation returned false");await g()}catch(j){throw console.error("💳 Error in addCredits:",j),u(j instanceof Error?j.message:"Failed to add credits"),j}},[e,g]),$=P.useCallback(async(_,f,E)=>{if(!e)throw new Error("User not authenticated");if(_<=0)throw new Error("Refund amount must be positive");try{u(null);const{data:x,error:j}=await N.rpc("refund_credits",{user_uuid:e.id,credits_amount:_,refund_reason:f,original_analysis_id:E||null});if(j)throw console.error("💳 Error refunding credits:",j),new Error(`Failed to refund credits: ${j.message}`);if(!x)throw new Error("Failed to refund credits - database operation returned false");await g()}catch(x){throw console.error("💳 Error in refundCredits:",x),u(x instanceof Error?x.message:"Failed to refund credits"),x}},[e,g]),F=P.useCallback(async()=>{try{if(a(!0),u(null),e){e.email;const _=await g()}else s(0),o(null),p(null)}catch(_){console.error("💳 Error refreshing credits:",_),u("Failed to refresh credits")}finally{a(!1)}},[e,g]),S=P.useCallback(_=>Ht.calculateCreditsForDuration(_),[]),C=P.useCallback(_=>Ht.estimateConsumption(_,r),[r]),I=P.useCallback(async(_=1)=>{try{if(_<=0)return!0;const f=await Y.generate(),{data:E,error:x}=await N.rpc("check_trial_credits",{fingerprint_hash_param:f,required_credits:_});if(x)return console.error("💳 Error checking trial credits:",x),_<=100;const j=E===!0;return j}catch(f){return console.error("💳 Error in checkTrialCredits:",f),_<=100}},[]),d=P.useCallback(async(_,f,E)=>{if(_<=0)throw new Error("Credit amount must be positive");try{if(!await I(_))throw new Error(`Insufficient trial credits. Required: ${_} credits`);const j=await Y.generate(),{data:L,error:z}=await N.rpc("consume_trial_credits",{fingerprint_hash_param:j,credits_amount:_,analysis_description:f,analysis_id:E||null});if(z)throw console.error("💳 Error consuming trial credits:",z),new Error(`Failed to consume trial credits: ${z.message}`);if(!L)throw new Error("Insufficient trial credits or consumption failed")}catch(x){throw console.error("💳 Error in consumeTrialCredits:",x),x}},[I]),y=P.useCallback(async(_,f,E)=>{if(_<=0)throw new Error("Refund amount must be positive");try{const x=await Y.generate(),{data:j,error:L}=await N.rpc("refund_trial_credits",{fingerprint_hash_param:x,credits_amount:_,refund_reason:f,original_analysis_id:E||null});if(L)throw console.error("💳 Error refunding trial credits:",L),new Error(`Failed to refund trial credits: ${L.message}`);if(!j)throw new Error("Failed to refund trial credits - database operation returned false")}catch(x){throw console.error("💳 Error in refundTrialCredits:",x),x}},[]),v=P.useCallback(async()=>{try{const _=await Y.generate(),{data:f,error:E}=await N.from("device_fingerprints").select("trial_credits, credits_used").eq("fingerprint_hash",_).is("deleted_at",null).is("user_id",null).single();if(E){if(E.code==="PGRST116")return{total:100,used:0,remaining:100};throw E}const x={total:f.trial_credits||100,used:f.credits_used||0,remaining:(f.trial_credits||100)-(f.credits_used||0)};return x}catch(_){return console.error("💳 Error getting trial credit balance:",_),{total:100,used:0,remaining:100}}},[]),w=P.useCallback(async()=>{if(e)try{const _=await Y.generate(),f=await v();if(f.remaining>0){await T(f.remaining,"trial_grant",`Migrated ${f.remaining} trial credits from device fingerprint`),f.remaining;const E=`trial_used_${_}`;localStorage.setItem(E,"true")}await Y.associateWithUser(e.id,_)}catch(_){console.error("💳 Error migrating trial credits:",_)}},[e,v,T]),b=P.useCallback(async()=>h,[h]);P.useEffect(()=>{t||(e?g().then(_=>{}).catch(_=>{console.error("💳 Failed to initialize credits:",_),s(200),o({total:200,trial:0,monthly:200,purchased:0})}).finally(()=>{a(!1)}):(s(0),o(null),p(null),a(!1)))},[e?.id,t,g]);const m={credits:r,creditBalance:i,loading:l,error:c,subscription:h,checkCredits:g,consumeCredits:A,addCredits:T,refundCredits:$,refreshCredits:F,calculateCreditsForDuration:S,estimateConsumption:C,checkTrialCredits:I,consumeTrialCredits:d,refundTrialCredits:y,getTrialCreditBalance:v,migrateTrialCreditsToUser:w,getSubscriptionStatus:b};return Jt.jsx(gr.Provider,{value:m,children:n})}function Ci(){const n=P.useContext(gr);if(n===void 0)throw new Error("useCredit must be used within a CreditProvider");return n}function Bi(){const{checkTrialCredits:n,consumeTrialCredits:e,refundTrialCredits:t,getTrialCreditBalance:r,calculateCreditsForDuration:s}=Ci();return{checkTrialCredits:n,consumeTrialCredits:e,refundTrialCredits:t,getTrialCreditBalance:r,calculateCreditsForDuration:s}}export{Di as A,Ni as C,Re as _,Ci as a,Ht as b,Bi as c,Li as d,Fi as e,Ui as f,Jt as j,N as s,fr as u};
