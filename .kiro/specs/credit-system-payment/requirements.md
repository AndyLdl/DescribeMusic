# 需求文档

## 介绍

本功能旨在将现有的使用次数限制系统升级为积分制系统，并集成Lemonsqueezy支付功能。系统将基于音频时长计算积分消费（1秒=1积分），为新用户提供100积分试用，注册用户每月获得200积分，并提供三档订阅套餐（$9.9、$19.9、$29.9）供用户购买额外积分。

## 需求

### 需求 1：积分制系统

**用户故事：** 作为一个用户，我希望系统基于音频时长消费积分而不是固定次数，这样我可以更灵活地使用分析服务。

#### 验收标准

1. 当系统计算积分消费时，应当按照1秒音频=1积分的比例计算
2. 当未注册用户首次访问时，系统应当提供100积分的免费试用
3. 当用户注册成功后，系统应当每月自动赠送200积分
4. 当用户上传音频文件时，系统应当预先计算所需积分并显示给用户
5. 当用户确认分析时，系统应当检查积分余额是否足够
6. 如果积分不足，系统应当阻止分析并提示用户购买积分
7. 当分析完成后，系统应当从用户积分余额中扣除相应积分
8. 当新的月份开始时，系统应当为注册用户自动添加200积分

### 需求 2：Lemonsqueezy支付集成

**用户故事：** 作为一个用户，我希望能够通过安全的支付方式购买积分，这样我可以继续使用分析服务。

#### 验收标准

1. 当用户点击购买积分时，系统应当显示三个订阅套餐选项
2. 当用户选择$9.9套餐时，系统应当提供2000积分
3. 当用户选择$19.9套餐时，系统应当提供4000积分
4. 当用户选择$29.9套餐时，系统应当提供6000积分
5. 当用户确认购买时，系统应当重定向到Lemonsqueezy支付页面
6. 当支付成功后，系统应当通过webhook接收支付确认
7. 当收到支付确认时，系统应当立即为用户账户添加相应积分
8. 当支付失败时，系统应当显示错误信息并允许用户重试

### 需求 3：订阅模式管理

**用户故事：** 作为一个用户，我希望能够管理我的订阅状态，这样我可以了解和控制我的付费情况。

#### 验收标准

1. 当用户购买订阅后，系统应当记录订阅状态和到期时间
2. 当订阅到期前7天时，系统应当提醒用户续费
3. 当订阅到期后，系统应当停止自动添加积分
4. 当用户查看账户信息时，系统应当显示当前订阅状态和剩余积分
5. 当用户想要取消订阅时，系统应当提供取消订阅的链接
6. 当用户升级或降级订阅时，系统应当按比例调整积分
7. 当用户有多个有效订阅时，系统应当按最高等级计算积分

### 需求 4：积分消费计算

**用户故事：** 作为一个系统管理员，我希望积分消费计算准确且透明，这样用户可以清楚了解费用。

#### 验收标准

1. 当用户上传音频文件时，系统应当准确检测音频时长
2. 当计算积分消费时，系统应当向上取整到最近的秒数
3. 当显示积分消费时，系统应当同时显示时长和积分数量
4. 当分析开始前，系统应当再次确认积分余额充足
5. 当分析过程中出错时，系统应当不扣除积分或退还已扣积分
6. 当用户查看历史记录时，系统应当显示每次分析的积分消费
7. 当生成账单时，系统应当详细列出所有积分消费记录

### 需求 5：用户界面更新

**用户故事：** 作为一个用户，我希望界面能够清晰显示积分信息和购买选项，这样我可以方便地管理我的账户。

#### 验收标准

1. 当用户查看上传界面时，系统应当显示当前积分余额
2. 当用户选择文件后，系统应当显示预估积分消费
3. 当积分不足时，系统应当显示购买积分的按钮
4. 当用户点击购买积分时，系统应当显示订阅套餐选择界面
5. 当用户在分析过程中，系统应当显示积分扣除状态
6. 当用户查看历史记录时，系统应当显示每条记录的积分消费
7. 当用户查看个人资料时，系统应当显示积分余额、订阅状态和消费历史

### 需求 6：数据迁移和兼容性

**用户故事：** 作为一个现有用户，我希望系统能够平滑迁移到新的积分制，这样我不会丢失现有的使用权益。

#### 验收标准

1. 当系统升级时，现有试用用户的剩余次数应当转换为积分
2. 当转换试用次数时，每次应当等价于180积分（3分钟平均时长）
3. 当现有注册用户升级时，剩余月度次数应当转换为积分
4. 当转换月度次数时，每次应当等价于180积分
5. 当用户有历史分析记录时，系统应当保持这些记录的完整性
6. 当系统显示历史记录时，旧记录应当显示为"历史记录"而不是积分消费
7. 当计算月度重置时，系统应当同时支持旧的次数制和新的积分制

### 需求 7：Webhook和安全性

**用户故事：** 作为一个系统管理员，我希望支付处理安全可靠，这样可以保护用户数据和防止欺诈。

#### 验收标准

1. 当接收Lemonsqueezy webhook时，系统应当验证签名的真实性
2. 当处理支付事件时，系统应当防止重复处理同一事件
3. 当支付验证失败时，系统应当记录错误日志并发送告警
4. 当用户数据发生变化时，系统应当确保数据一致性
5. 当存储支付信息时，系统应当遵循PCI DSS安全标准
6. 当处理敏感数据时，系统应当使用加密传输和存储
7. 当发生异常时，系统应当有完整的审计日志记录

### 需求 8：错误处理和用户体验

**用户故事：** 作为一个用户，我希望在遇到支付或积分问题时能够获得清晰的指导，这样我可以快速解决问题。

#### 验收标准

1. 当支付失败时，系统应当显示具体的失败原因和解决建议
2. 当积分计算出错时，系统应当显示友好的错误信息
3. 当网络连接失败时，系统应当提供重试选项
4. 当Lemonsqueezy服务不可用时，系统应当显示维护信息
5. 当用户账户出现异常时，系统应当提供客服联系方式
6. 当积分余额不足时，系统应当提供明确的购买指导
7. 当订阅状态异常时，系统应当提供状态查询和修复选项