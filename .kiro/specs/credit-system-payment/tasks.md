# 实施计划

- [x] 1. 设置积分系统数据库基础设施
  - 创建新的数据库表结构支持积分制系统
  - 设置数据库函数和存储过程处理积分操作
  - 配置Row Level Security策略确保数据安全
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7_

- [x] 1.1 创建积分系统数据库表
  - 创建user_credits表存储用户积分信息
  - 创建subscriptions表管理订阅状态
  - 创建credit_transactions表记录积分交易
  - 创建payment_records表存储支付记录
  - _需求: 4.1, 4.2, 4.3_

- [x] 1.2 实现积分操作数据库函数
  - 创建consume_credits函数处理积分消费
  - 创建add_credits函数处理积分添加
  - 创建reset_monthly_credits函数处理月度重置
  - 添加数据库触发器自动更新时间戳
  - _需求: 4.4, 4.5, 4.6_

- [x] 1.3 配置数据库安全策略
  - 为积分相关表设置Row Level Security策略
  - 配置用户权限确保数据访问安全
  - 设置数据库索引优化查询性能
  - _需求: 4.7, 7.1, 7.2, 7.3_

- [x] 2. 实现音频时长检测和积分计算
  - 创建AudioDurationDetector类检测音频文件时长
  - 实现积分计算逻辑（1秒=1积分）
  - 添加音频格式支持和错误处理
  - _需求: 1.1, 1.4, 4.1, 4.2, 4.3_

- [x] 2.1 创建音频时长检测服务
  - 实现src/utils/audioDurationDetector.ts文件
  - 支持多种音频格式的时长检测
  - 添加Web Audio API和HTML5 Audio fallback
  - _需求: 1.1, 4.1, 4.2_

- [x] 2.2 实现积分计算逻辑
  - 创建积分计算函数（向上取整到秒）
  - 添加积分消费预估和显示格式化
  - 实现积分余额检查和验证
  - _需求: 1.4, 4.3, 4.4_

- [x] 2.3 集成到现有文件上传流程
  - 修改文件选择处理逻辑检测时长
  - 在上传前显示预估积分消费
  - 添加积分不足时的用户提示
  - _需求: 1.5, 1.6, 5.2, 5.3_

- [x] 3. 创建积分管理Context和Provider
  - 实现CreditProvider React Context管理积分状态
  - 集成Supabase进行积分数据操作
  - 添加积分消费、添加和查询功能
  - _需求: 1.1, 1.2, 1.3, 1.7, 1.8_

- [x] 3.1 创建CreditProvider Context
  - 实现src/contexts/CreditContext.tsx文件
  - 定义CreditContextType接口和状态管理
  - 集成现有AuthContext获取用户信息
  - _需求: 1.1, 1.2, 1.3_

- [x] 3.2 实现积分操作方法
  - 添加checkCredits方法查询积分余额
  - 实现consumeCredits方法处理积分消费
  - 添加addCredits方法处理积分添加
  - _需求: 1.7, 1.8_

- [x] 3.3 集成试用用户积分管理
  - 扩展设备指纹系统支持积分制
  - 为未注册用户提供100积分试用
  - 实现试用积分的消费和查询
  - _需求: 1.2, 6.1, 6.2_

- [x] 4. 集成Lemonsqueezy支付系统
  - 创建LemonsqueezyService处理支付API调用
  - 实现订阅套餐创建和管理
  - 添加支付结账流程和重定向
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 2.8_

- [x] 4.1 创建Lemonsqueezy服务类
  - 实现src/services/lemonsqueezyService.ts文件
  - 集成@lemonsqueezy/lemonsqueezy.js SDK
  - 配置API密钥和商店设置
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 4.2 实现支付结账功能
  - 创建createCheckout方法生成支付链接
  - 实现三档订阅套餐配置
  - 添加自定义数据传递用户信息
  - _需求: 2.5, 2.6_

- [x] 4.3 添加订阅管理功能
  - 实现getSubscription方法查询订阅状态
  - 添加cancelSubscription方法取消订阅
  - 创建订阅状态同步机制
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7_

- [x] 5. 创建支付界面组件
  - 实现PaymentModal组件显示订阅套餐
  - 添加套餐选择和价格显示
  - 集成支付流程和用户反馈
  - _需求: 2.1, 2.2, 2.3, 2.4, 5.4, 8.1, 8.2_

- [x] 5.1 创建PaymentModal组件
  - 实现src/components/payment/PaymentModal.tsx
  - 设计响应式支付界面布局
  - 添加套餐选择和价格对比
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 5.2 实现套餐选择逻辑
  - 配置三档订阅套餐信息
  - 添加套餐推荐和价值展示
  - 实现套餐选择状态管理
  - _需求: 5.4_

- [x] 5.3 集成支付流程
  - 连接Lemonsqueezy结账API
  - 处理支付成功和失败状态
  - 添加加载状态和错误处理
  - _需求: 8.1, 8.2, 8.3, 8.4_

- [x] 6. 修改现有组件支持积分制
  - 更新AnalyzeApp.tsx集成积分检查
  - 修改UploadSection.tsx显示积分信息
  - 更新Header组件显示积分余额
  - _需求: 5.1, 5.2, 5.3, 5.5, 5.6, 5.7_

- [x] 6.1 修改AnalyzeApp主组件
  - 包装CreditProvider到应用根组件
  - 修改文件处理流程集成积分检查
  - 添加积分不足时的支付引导
  - _需求: 5.1, 5.2, 5.3_

- [x] 6.2 更新UploadSection组件
  - 添加CreditIndicator组件显示积分余额
  - 显示音频时长和预估积分消费
  - 集成积分不足时的购买按钮
  - _需求: 5.5, 5.6_

- [x] 6.3 修改Header组件显示积分
  - 在用户菜单中显示当前积分余额
  - 添加"购买积分"快捷入口
  - 显示订阅状态和到期时间
  - _需求: 5.7_

- [x] 7. 实现Webhook处理云函数
  - 创建lemonsqueezy-webhook云函数处理支付事件
  - 实现Webhook签名验证和事件处理
  - 添加支付成功后的积分发放逻辑
  - _需求: 2.7, 2.8, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7_

- [x] 7.1 创建Webhook处理云函数
  - 创建cloud-functions/src/functions/lemonsqueezyWebhook.ts
  - 配置Firebase Cloud Functions HTTP触发器
  - 实现基础的请求处理和路由
  - _需求: 2.7, 7.1, 7.2_

- [x] 7.2 实现Webhook签名验证
  - 添加Lemonsqueezy签名验证逻辑
  - 实现防重放攻击保护
  - 添加请求日志和错误处理
  - _需求: 7.3, 7.4, 7.7_

- [x] 7.3 处理支付成功事件
  - 解析支付成功Webhook数据
  - 验证支付金额和用户信息
  - 调用积分添加函数发放积分
  - 更新订阅状态和支付记录
  - _需求: 2.8, 7.5, 7.6_

- [x] 8. 修改音频分析云函数支持积分制
  - 更新analyzeAudio函数集成积分验证
  - 实现分析前积分检查和分析后积分扣除
  - 添加积分不足时的错误处理
  - _需求: 1.5, 1.6, 1.7, 4.5, 4.6, 4.7_

- [x] 8.1 修改analyzeAudio云函数
  - 在现有analyzeAudio函数中添加积分验证中间件
  - 实现分析前的积分余额检查
  - 添加音频时长检测和积分计算
  - _需求: 1.5, 1.6, 4.5_

- [x] 8.2 实现积分消费逻辑
  - 在分析开始前预扣积分
  - 分析成功后确认积分消费
  - 分析失败时退还预扣积分
  - _需求: 1.7, 4.6, 4.7_

- [x] 8.3 添加积分相关错误处理
  - 定义积分不足错误类型
  - 返回友好的错误信息给前端
  - 记录积分操作日志
  - _需求: 8.1, 8.2, 8.6, 8.7_

- [x] 9. 实现数据迁移脚本
  - 创建现有用户数据到积分制的迁移脚本
  - 转换试用次数和月度次数为积分
  - 确保数据迁移的完整性和一致性
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7_

- [x] 9.1 创建用户数据迁移脚本
  - 编写SQL脚本迁移现有用户配置
  - 转换剩余使用次数为等价积分
  - 为现有用户设置初始积分余额
  - _需求: 6.1, 6.2, 6.3_

- [x] 9.2 迁移设备指纹试用数据
  - 更新device_fingerprints表结构
  - 转换试用次数为试用积分
  - 保持向后兼容性
  - _需求: 6.4, 6.5_

- [x] 9.3 验证迁移数据完整性
  - 创建数据验证脚本检查迁移结果
  - 对比迁移前后的用户权益
  - 修复任何数据不一致问题
  - _需求: 6.6, 6.7_

- [x] 10. 实现订阅管理界面
  - 创建SubscriptionModal组件管理用户订阅
  - 显示当前订阅状态和积分使用情况
  - 添加订阅升级、降级和取消功能
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7_

- [x] 10.1 创建SubscriptionModal组件
  - 实现src/components/subscription/SubscriptionModal.tsx
  - 显示当前订阅详情和积分余额
  - 添加订阅历史和使用统计
  - _需求: 3.1, 3.4_

- [x] 10.2 实现订阅管理功能
  - 添加订阅升级和降级选项
  - 实现订阅取消和恢复功能
  - 显示订阅到期提醒
  - _需求: 3.2, 3.3, 3.5, 3.6_

- [x] 10.3 集成积分使用分析
  - 显示积分消费历史图表
  - 提供积分使用预测和建议
  - 添加积分不足预警
  - _需求: 3.7_

- [x] 11. 添加积分系统错误处理和用户体验优化
  - 实现全局错误处理针对积分和支付错误
  - 添加用户友好的错误信息和解决建议
  - 优化加载状态和用户反馈
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6, 8.7_

- [x] 11.1 创建积分错误处理组件
  - 实现CreditErrorBoundary组件
  - 添加积分不足和支付失败的错误处理
  - 提供用户友好的错误信息和操作建议
  - _需求: 8.1, 8.2, 8.3_

- [x] 11.2 优化支付流程用户体验
  - 添加支付过程中的加载状态
  - 实现支付成功和失败的反馈
  - 添加支付重试和客服联系选项
  - _需求: 8.4, 8.5_

- [x] 11.3 实现离线支持和错误恢复
  - 添加网络状态检测和离线提示
  - 实现支付状态的本地缓存和同步
  - 添加数据同步失败的恢复机制
  - _需求: 8.6, 8.7_

- [x] 12. 实现积分系统监控和分析
  - 添加积分消费和支付成功率监控
  - 创建用户行为分析和转换率跟踪
  - 实现异常检测和告警机制
  - _需求: 监控和运营需求_

- [x] 12.1 创建积分系统监控
  - 添加积分消费率和余额分布监控
  - 实现支付成功率和失败原因分析
  - 创建订阅转换率和流失率跟踪
  - _需求: 运营监控需求_

- [x] 12.2 实现用户行为分析
  - 跟踪用户从试用到付费的转换路径
  - 分析不同套餐的选择偏好
  - 监控积分使用模式和预测需求
  - _需求: 用户行为分析需求_

- [x] 12.3 添加异常检测和告警
  - 实现积分异常消费检测
  - 添加支付失败和欺诈检测
  - 创建系统性能和可用性监控
  - _需求: 系统稳定性需求_

- [x] 13. 创建积分系统单元测试和集成测试
  - 为积分计算和支付逻辑创建单元测试
  - 测试Lemonsqueezy集成和Webhook处理
  - 添加端到端测试覆盖完整支付流程
  - _需求: 所有需求的测试覆盖_

- [x] 13.1 创建积分系统单元测试
  - 测试AudioDurationDetector的时长检测准确性
  - 验证积分计算逻辑的正确性
  - 测试CreditProvider的状态管理
  - _需求: 1.1, 1.4, 4.1, 4.2, 4.3_

- [x] 13.2 添加支付系统集成测试
  - 测试LemonsqueezyService的API调用
  - 验证Webhook处理的完整性
  - 测试支付成功后的积分发放
  - _需求: 2.1-2.8, 7.1-7.7_

- [x] 13.3 实现端到端测试
  - 测试完整的用户购买和消费流程
  - 验证订阅管理和取消流程
  - 测试数据迁移的正确性
  - _需求: 所有用户故事的端到端验证_

- [ ] 14. 部署积分系统到生产环境
  - 配置生产环境的Lemonsqueezy设置
  - 部署新的云函数和数据库更改
  - 执行数据迁移和系统切换
  - _需求: 部署和运营需求_

- [ ] 14.1 配置生产环境
  - 设置生产环境的Lemonsqueezy API密钥
  - 配置Webhook端点和签名验证
  - 更新环境变量和安全设置
  - _需求: 7.1, 7.2, 7.3_

- [ ] 14.2 部署系统更新
  - 部署新的云函数到Firebase
  - 执行数据库schema更新
  - 更新前端应用并发布
  - _需求: 部署需求_

- [ ] 14.3 执行数据迁移和验证
  - 在生产环境执行用户数据迁移
  - 验证迁移后的数据完整性
  - 监控系统性能和用户反馈
  - _需求: 6.1-6.7, 监控需求_