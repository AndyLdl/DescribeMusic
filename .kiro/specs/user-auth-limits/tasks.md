# 实施计划

- [x] 1. 设置Supabase基础设施和数据库
  - 创建Supabase项目并配置数据库表结构
  - 设置Row Level Security策略确保数据安全
  - 配置环境变量和连接设置
  - _需求: 4.1, 4.2, 4.3, 4.5, 4.7_

- [x] 1.1 创建Supabase项目和数据库表
  - 在Supabase控制台创建新项目
  - 执行SQL脚本创建user_profiles、device_fingerprints、usage_logs表
  - 设置数据库索引优化查询性能
  - _需求: 4.1, 4.2_

- [x] 1.2 配置Row Level Security策略
  - 为user_profiles表设置RLS策略，用户只能访问自己的数据
  - 为usage_logs表设置RLS策略，限制用户查看权限
  - 为device_fingerprints表设置适当的访问控制
  - _需求: 4.3, 4.5_

- [x] 1.3 设置环境变量和配置
  - 在项目根目录添加Supabase配置到环境变量
  - 在云函数中添加Supabase服务端配置
  - 创建配置文件管理Supabase连接设置
  - _需求: 4.7_

- [x] 2. 实现设备指纹生成服务
  - 创建DeviceFingerprint类生成唯一设备标识
  - 实现浏览器特征收集和哈希算法
  - 添加设备指纹缓存和管理功能
  - _需求: 5.1, 5.2, 5.3, 5.6_

- [x] 2.1 创建设备指纹核心算法
  - 实现src/utils/deviceFingerprint.ts文件
  - 收集屏幕分辨率、时区、语言等浏览器特征
  - 使用Canvas和WebGL生成指纹组件
  - _需求: 5.1, 5.2_

- [x] 2.2 实现指纹哈希和存储
  - 使用SHA-256算法对指纹进行安全哈希
  - 实现指纹本地缓存避免重复生成
  - 添加指纹验证和更新机制
  - _需求: 5.3, 5.6_

- [x] 2.3 集成Supabase设备指纹管理
  - 实现设备指纹的Supabase存储和查询
  - 添加试用次数的读取和更新功能
  - 实现设备指纹与用户账户的关联
  - _需求: 5.4, 5.5_

- [x] 3. 创建认证Context和Provider
  - 实现AuthProvider React Context管理用户状态
  - 集成Supabase认证服务和会话管理
  - 添加使用限制状态管理和检查功能
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 2.3, 2.4, 2.5_

- [x] 3.1 创建AuthProvider Context
  - 实现src/contexts/AuthContext.tsx文件
  - 定义AuthContextType接口包含用户状态和方法
  - 集成Supabase客户端进行认证操作
  - _需求: 1.1, 1.2, 1.3_

- [x] 3.2 实现认证方法
  - 添加signUp、signIn、signOut方法
  - 实现密码重置和邮箱验证功能
  - 添加会话状态监听和自动刷新
  - _需求: 1.4, 1.5, 1.6_

- [x] 3.3 集成使用限制管理
  - 实现checkUsageLimit方法检查用户使用状态
  - 添加consumeUsage方法更新使用计数
  - 集成设备指纹服务进行试用用户管理
  - _需求: 2.3, 2.4, 2.5_

- [x] 4. 修改现有AnalyzeApp组件集成认证
  - 在AnalyzeApp.tsx中包装AuthProvider
  - 修改startAnalysis方法添加使用限制检查
  - 更新UI状态根据认证状态显示不同内容
  - _需求: 3.1, 3.2, 3.3, 3.4_

- [x] 4.1 包装AuthProvider到AnalyzeApp
  - 修改src/components/AnalyzeApp.tsx包装AuthProvider
  - 传递认证状态到所有子组件
  - 添加认证加载状态处理
  - _需求: 3.1, 3.2_

- [x] 4.2 修改音频分析流程
  - 在startAnalysis方法中添加使用限制检查
  - 根据认证状态调用不同的分析API
  - 添加使用次数消费逻辑
  - _需求: 3.3, 3.4_

- [x] 4.3 更新组件状态管理
  - 根据认证状态调整上传和结果显示组件
  - 添加错误处理针对使用限制超出情况
  - 实现认证状态变化的UI响应
  - _需求: 3.1, 3.4_

- [x] 5. 创建登录注册UI组件
  - 实现LoginModal模态框组件
  - 添加表单验证和错误处理
  - 集成到Header组件显示登录按钮
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 6.1, 6.2, 6.3_

- [x] 5.1 创建LoginModal组件
  - 实现src/components/auth/LoginModal.tsx
  - 创建响应式登录/注册表单
  - 使用react-hook-form进行表单管理
  - _需求: 1.1, 1.2, 1.3_

- [x] 5.2 添加表单验证和错误处理
  - 使用zod进行输入验证
  - 实现友好的错误信息显示
  - 添加加载状态和成功反馈
  - _需求: 1.4, 6.1, 6.2_

- [x] 5.3 集成到Header组件
  - 修改src/components/Header.astro添加认证按钮
  - 实现用户头像和下拉菜单
  - 添加登出功能和用户信息显示
  - _需求: 1.5, 1.6, 6.3_

- [x] 6. 修改UploadSection添加使用限制显示
  - 创建UsageIndicator组件显示剩余次数
  - 根据使用限制状态禁用或启用上传功能
  - 添加试用用户的注册引导提示
  - _需求: 2.1, 2.2, 2.7, 3.5, 3.6, 3.7_

- [x] 6.1 创建UsageIndicator组件
  - 实现使用次数显示组件
  - 区分试用用户和注册用户的显示样式
  - 添加进度条和剩余次数可视化
  - _需求: 2.1, 2.2, 3.5_

- [x] 6.2 修改UploadSection集成使用限制
  - 在上传区域添加UsageIndicator组件
  - 根据使用限制状态禁用上传按钮
  - 添加限制达到时的提示信息
  - _需求: 2.7, 3.6_

- [x] 6.3 实现注册引导功能
  - 为试用用户添加注册提示
  - 在使用次数不足时显示升级建议
  - 添加一键注册按钮和流程
  - _需求: 3.7_

- [x] 7. 修改云函数添加使用限制验证
  - 在analyzeAudio函数中添加认证中间件
  - 实现Supabase服务端验证逻辑
  - 添加使用记录和计数更新功能
  - _需求: 2.3, 2.4, 2.5, 2.8, 4.4, 4.6_

- [x] 7.1 创建Supabase服务端集成
  - 在云函数中添加@supabase/supabase-js依赖
  - 创建cloud-functions/src/services/supabaseService.ts
  - 实现服务端认证验证和数据库操作
  - _需求: 4.4, 4.6_

- [x] 7.2 实现使用限制验证中间件
  - 在analyzeAudio函数中添加使用限制检查
  - 验证JWT令牌和设备指纹
  - 实现试用用户和注册用户的不同限制逻辑
  - _需求: 2.3, 2.4, 2.5_

- [x] 7.3 添加使用记录和计数更新
  - 在分析完成后记录使用日志
  - 更新用户月度使用计数或设备试用计数
  - 实现月度重置和计数管理逻辑
  - _需求: 2.8_

- [x] 8. 修改cloudFunctions.ts客户端集成认证
  - 在API调用中添加认证头和设备指纹
  - 实现使用限制错误处理
  - 添加认证状态检查和重试逻辑
  - _需求: 2.3, 2.4, 2.5, 6.1, 6.2, 6.4_

- [x] 8.1 修改CloudFunctionsClient类
  - 在src/utils/cloudFunctions.ts中添加认证支持
  - 修改analyzeAudio方法包含认证头
  - 添加设备指纹到请求头
  - _需求: 2.3, 2.4_

- [x] 8.2 实现使用限制错误处理
  - 添加USAGE_LIMIT_EXCEEDED错误类型
  - 实现友好的错误信息和用户引导
  - 添加自动重试和认证刷新逻辑
  - _需求: 2.5, 6.1, 6.2_

- [x] 8.3 集成认证状态管理
  - 从AuthContext获取认证状态
  - 实现会话过期处理和自动登录
  - 添加网络错误和认证错误的区分处理
  - _需求: 6.4_

- [x] 9. 更新历史记录系统支持用户关联
  - 修改historyStorage.ts支持用户ID关联
  - 实现历史记录的用户隔离和同步
  - 添加匿名历史记录到用户账户的迁移
  - _需求: 3.2, 3.4, 5.4_

- [x] 9.1 修改HistoryStorage类
  - 在src/utils/historyStorage.ts中添加用户ID支持
  - 实现基于用户的历史记录存储和检索
  - 保持向后兼容性支持匿名用户历史
  - _需求: 3.2, 3.4_

- [x] 9.2 实现历史记录迁移
  - 添加匿名历史记录到用户账户的关联功能
  - 在用户首次登录时迁移本地历史记录
  - 实现历史记录的云端同步机制
  - _需求: 5.4_

- [x] 9.3 更新HistorySidebar组件
  - 修改历史记录显示支持用户状态
  - 添加历史记录的用户标识和过滤
  - 实现登录后历史记录的自动刷新
  - _需求: 3.2, 3.4_

- [-] 10. 实现错误处理和用户体验优化
  - 添加全局错误边界和错误处理
  - 实现加载状态和用户反馈机制
  - 优化认证流程的用户体验
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 10.1 创建错误处理组件
  - 实现ErrorBoundary组件捕获React错误
  - 添加网络错误和认证错误的统一处理
  - 创建用户友好的错误信息显示
  - _需求: 6.1, 6.2_

- [ ] 10.2 优化加载状态和反馈
  - 在认证操作中添加加载指示器
  - 实现操作成功的反馈提示
  - 优化页面切换和状态变化的平滑过渡
  - _需求: 6.3, 6.4_

- [ ] 10.3 实现离线支持和错误恢复
  - 添加网络状态检测和离线提示
  - 实现认证失败的自动重试机制
  - 添加数据同步失败的恢复策略
  - _需求: 6.5_

- [ ] 11. 添加单元测试和集成测试
  - 为认证服务创建单元测试
  - 测试设备指纹生成和使用限制逻辑
  - 添加端到端测试覆盖完整用户流程
  - _需求: 所有需求的测试覆盖_

- [ ] 11.1 创建认证服务单元测试
  - 测试AuthProvider的所有方法
  - 验证设备指纹生成的一致性和唯一性
  - 测试使用限制检查和计数逻辑
  - _需求: 1.1-1.6, 2.1-2.9, 5.1-5.6_

- [ ] 11.2 添加组件集成测试
  - 测试AnalyzeApp的认证集成
  - 验证UploadSection的使用限制显示
  - 测试LoginModal的表单验证和提交
  - _需求: 3.1-3.7_

- [ ] 11.3 实现端到端测试
  - 测试完整的用户注册和登录流程
  - 验证试用用户到注册用户的转换
  - 测试使用限制达到时的用户体验
  - _需求: 所有用户故事的端到端验证_

- [ ] 12. 部署和监控设置
  - 配置生产环境的Supabase设置
  - 添加使用情况监控和分析
  - 实现用户行为跟踪和转换率分析
  - _需求: 部署和运营需求_

- [ ] 12.1 配置生产环境
  - 设置生产环境的Supabase项目
  - 配置环境变量和安全设置
  - 实施数据库备份和恢复策略
  - _需求: 4.5, 4.7_

- [ ] 12.2 实现监控和分析
  - 添加用户注册和使用情况的监控
  - 实现试用转换率的跟踪分析
  - 设置错误监控和性能指标
  - _需求: 运营监控需求_

- [ ] 12.3 优化性能和用户体验
  - 优化认证流程的响应时间
  - 实现缓存策略减少API调用
  - 添加用户反馈收集和改进机制
  - _需求: 性能和用户体验优化_