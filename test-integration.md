# 🧪 音频分析集成测试指南

## 📋 测试步骤

### 1. 启动后端服务

```bash
# 进入云函数目录
cd cloud-functions

# 启动Firebase模拟器
npm run serve
```

**期望结果**：模拟器在 http://localhost:5001 启动，显示：

- ✅ analyzeAudio 函数已加载
- ✅ healthCheck 函数已加载
- ✅ version 函数已加载

### 2. 启动前端服务

```bash
# 在另一个终端窗口，回到项目根目录
cd /Users/andy/VSCodeProjects/DescribeMusic

# 启动前端开发服务器
pnpm dev
```

**期望结果**：前端在 http://localhost:4321 启动

### 3. 测试音频文件上传

1. **访问分析页面**：http://localhost:4321/analyze
2. **准备测试文件**：任何音频文件（MP3, WAV, M4A 等，小于 50MB）
3. **上传测试**：
   - 拖拽文件到上传区域，或
   - 点击上传按钮选择文件

**期望结果**：

- ✅ 文件验证通过
- ✅ 显示分析进度界面
- ✅ 调用云函数进行分析
- ✅ 显示详细分析结果

### 4. 验证功能

#### 4.1 基本功能测试

- [ ] 文件上传（拖拽 + 点击）
- [ ] 文件类型验证
- [ ] 文件大小验证
- [ ] 分析进度显示
- [ ] 结果展示

#### 4.2 分析结果验证

- [ ] 基本信息（类型、情绪、BPM、调性）
- [ ] 情感分析数据
- [ ] 音频质量评估
- [ ] AI 生成的标签
- [ ] AI 音乐描述
- [ ] 相似曲目推荐

#### 4.3 历史记录功能

- [ ] 分析结果自动保存到历史
- [ ] 历史列表显示
- [ ] 点击历史记录查看详情
- [ ] 缩略图显示

#### 4.4 错误处理

- [ ] 无效文件类型错误
- [ ] 文件过大错误
- [ ] 网络连接错误
- [ ] 云函数调用失败
- [ ] 重试和新建分析功能

#### 4.5 UI/UX

- [ ] 响应式设计（桌面/移动端）
- [ ] 加载动画
- [ ] 错误提示
- [ ] 操作反馈

## 🔧 调试技巧

### 前端调试

```bash
# 打开浏览器开发者工具
# 查看 Console 标签页的日志
# 查看 Network 标签页的API请求
```

### 后端调试

```bash
# 查看云函数日志
cd cloud-functions
firebase functions:log --only analyzeAudio

# 或查看模拟器实时日志
# 在运行模拟器的终端查看输出
```

### 测试云函数连接

```bash
# 测试健康检查端点
curl http://localhost:5001/describe-music/us-central1/healthCheck

# 测试分析端点（应该返回400错误，因为没有文件）
curl -X POST http://localhost:5001/describe-music/us-central1/analyzeAudio
```

## 🚨 常见问题

### 1. "Network Error" 或连接失败

**可能原因**：

- 云函数模拟器未启动
- 前端环境变量配置错误
- CORS 问题

**解决方案**：

- 确认模拟器在 5001 端口运行
- 检查 `.env` 文件中的 `VITE_CLOUD_FUNCTIONS_URL`
- 重启前端开发服务器

### 2. "Function not found" 错误

**可能原因**：

- 云函数编译失败
- 函数名称不匹配

**解决方案**：

- 运行 `npm run build` 重新编译
- 检查函数导出名称

### 3. 文件上传后无响应

**可能原因**：

- 云函数内部错误
- API 密钥未设置
- 超时设置过短

**解决方案**：

- 查看云函数日志
- 确认环境变量配置
- 检查 Gemini API 密钥

### 4. 分析结果显示异常

**可能原因**：

- 数据格式不匹配
- 前后端接口不一致

**解决方案**：

- 检查前端类型定义
- 验证云函数返回格式

## 📊 性能指标

### 预期性能

- **文件上传**：< 5 秒（取决于文件大小）
- **AI 分析**：30-120 秒（取决于音频长度和复杂度）
- **结果显示**：< 2 秒
- **历史加载**：< 1 秒

### 监控指标

- 请求成功率：> 95%
- 平均响应时间：< 60 秒
- 错误恢复时间：< 10 秒

## 🎯 测试用例

### 测试文件建议

1. **小文件**：< 5MB，MP3 格式，3 分钟以内
2. **中等文件**：10-20MB，WAV 格式，5-10 分钟
3. **大文件**：接近 50MB 限制的音频文件
4. **不同格式**：MP3, WAV, M4A, AAC, OGG, FLAC
5. **无效文件**：PDF, 图片, 文本文件（测试错误处理）

### 测试场景

1. **正常流程**：上传 → 分析 → 查看结果 → 保存历史
2. **错误流程**：无效文件 → 错误提示 → 重试
3. **中断流程**：分析中取消 → 重新开始
4. **历史查看**：查看历史记录 → 切换不同分析结果
5. **移动端**：在手机浏览器测试所有功能

---

**🎵 准备好测试你的音频分析功能了吗？**
